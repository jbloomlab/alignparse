
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>alignparse.targets &#8212; alignparse 0.1.1 documentation</title>
    <link rel="stylesheet" href="../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="../../_static/language_data.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for alignparse.targets</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">=======</span>
<span class="sd">targets</span>
<span class="sd">=======</span>

<span class="sd">Defines :class:`Targets`, which holds :class:`Target` objects that define</span>
<span class="sd">alignment targets. Each :class:`Target` has some :class:`Feature` regions.</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tempfile</span>

<span class="kn">import</span> <span class="nn">Bio.SeqIO</span>

<span class="kn">import</span> <span class="nn">dna_features_viewer</span>

<span class="kn">import</span> <span class="nn">matplotlib.cm</span>
<span class="kn">import</span> <span class="nn">matplotlib.colors</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">pathos</span>

<span class="kn">import</span> <span class="nn">pysam</span>

<span class="kn">import</span> <span class="nn">yaml</span>

<span class="kn">from</span> <span class="nn">alignparse.constants</span> <span class="k">import</span> <span class="n">CBPALETTE</span>
<span class="kn">from</span> <span class="nn">alignparse.cs_tag</span> <span class="k">import</span> <span class="p">(</span><span class="n">Alignment</span><span class="p">,</span>
                               <span class="n">cs_to_mutation_str</span><span class="p">,</span>
                               <span class="n">cs_to_nt_mutation_count</span><span class="p">,</span>
                               <span class="n">cs_to_op_mutation_count</span><span class="p">,</span>
                               <span class="n">cs_to_sequence</span><span class="p">,</span>
                               <span class="p">)</span>


<div class="viewcode-block" id="Feature"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Feature">[docs]</a><span class="k">class</span> <span class="nc">Feature</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A sequence feature within a :class:`Target` sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of feature.</span>
<span class="sd">    seq : str</span>
<span class="sd">        Sequence of feature.</span>
<span class="sd">    start: int</span>
<span class="sd">        Feature start in :class:`Target`, using Python-like 0, ... numbering.</span>
<span class="sd">    end : int</span>
<span class="sd">        Feature end in :class:`Target` using Python-like 0, ... numbering.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of feature.</span>
<span class="sd">    seq : str</span>
<span class="sd">        Sequence of feature.</span>
<span class="sd">    start : int</span>
<span class="sd">        Feature start in :class:`Target`, using Python-like 0, ... numbering.</span>
<span class="sd">    end : int</span>
<span class="sd">        Feature end in :class:`Target` using Python-like 0, ... numbering.</span>
<span class="sd">    length: int</span>
<span class="sd">        Length of feature.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">seq</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See main class docstring.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;comma not allowed in feature name: </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="n">seq</span>
        <span class="k">if</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">seq</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;length of `seq` not equal to `end` - `start`&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">start</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">end</span> <span class="o">-</span> <span class="n">start</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get string representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.__class__.__name__}</span><span class="s2">(name=</span><span class="si">{self.name}</span><span class="s2">, seq=</span><span class="si">{self.seq}</span><span class="s2">, &quot;</span>
                <span class="n">f</span><span class="s2">&quot;start=</span><span class="si">{self.start}</span><span class="s2">, end=</span><span class="si">{self.end}</span><span class="s2">)&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Target"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Target">[docs]</a><span class="k">class</span> <span class="nc">Target</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;A single target sequence.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seqrecord : Bio.SeqRecord.SeqRecord</span>
<span class="sd">        BioPython sequence record of target. Must have `seq`, `name`,</span>
<span class="sd">        and `features` attributes. Currently only handles + strand features.</span>
<span class="sd">    req_features : set or other iterable</span>
<span class="sd">        Required features in `seqrecord`.</span>
<span class="sd">    opt_features: set of other iterable</span>
<span class="sd">        Optional features in `seqrecord`.</span>
<span class="sd">    allow_extra_features : bool</span>
<span class="sd">        Can `seqrecord` have features not in `req_features` or `opt_features`?</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    seq : str</span>
<span class="sd">        Full sequence of target.</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of target.</span>
<span class="sd">    length : str</span>
<span class="sd">        Length of sequence.</span>
<span class="sd">    features : list</span>
<span class="sd">        List of all features as :class:`Feature` objects.</span>
<span class="sd">    feature_names : list</span>
<span class="sd">        List of names of all features.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get string representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.__class__.__name__}</span><span class="s2">(name=</span><span class="si">{self.name}</span><span class="s2">, seq=</span><span class="si">{self.seq}</span><span class="s2">, &quot;</span>
                <span class="n">f</span><span class="s2">&quot;features=</span><span class="si">{self.features}</span><span class="s2">)&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">seqrecord</span><span class="p">,</span> <span class="n">req_features</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span>
                 <span class="n">opt_features</span><span class="o">=</span><span class="nb">frozenset</span><span class="p">(),</span> <span class="n">allow_extra_features</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See main class docstring.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">seqrecord</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;,&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;comma not allowed in target name: </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">seqrecord</span><span class="p">,</span> <span class="s1">&#39;seq&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;`seqrecord` does not define a seq&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seq</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">seqrecord</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>

        <span class="n">allow_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">req_features</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">opt_features</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_features_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">bio_feature</span> <span class="ow">in</span> <span class="n">seqrecord</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">feature_name</span> <span class="o">=</span> <span class="n">bio_feature</span><span class="o">.</span><span class="n">type</span>
            <span class="k">if</span> <span class="n">feature_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;duplicate feature </span><span class="si">{feature_name}</span><span class="s2"> when &quot;</span>
                                 <span class="n">f</span><span class="s2">&quot;creating Target </span><span class="si">{self.name}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">allow_extra_features</span> <span class="ow">or</span> <span class="p">(</span><span class="n">feature_name</span> <span class="ow">in</span> <span class="n">allow_features</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;feature </span><span class="si">{feature_name}</span><span class="s2"> not allowed feature&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">bio_feature</span><span class="o">.</span><span class="n">strand</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;feature </span><span class="si">{feature_name}</span><span class="s2"> of </span><span class="si">{self.name}</span><span class="s2"> is - &quot;</span>
                                 <span class="s1">&#39;strand, but only + strand features handled&#39;</span><span class="p">)</span>
            <span class="n">feature_seq</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">bio_feature</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">extract</span><span class="p">(</span><span class="n">seqrecord</span><span class="p">)</span><span class="o">.</span><span class="n">seq</span><span class="p">)</span>
            <span class="n">feature</span> <span class="o">=</span> <span class="n">Feature</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">feature_name</span><span class="p">,</span>
                              <span class="n">seq</span><span class="o">=</span><span class="n">feature_seq</span><span class="p">,</span>
                              <span class="n">start</span><span class="o">=</span><span class="n">bio_feature</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                              <span class="n">end</span><span class="o">=</span><span class="n">bio_feature</span><span class="o">.</span><span class="n">location</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                              <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">feature_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_name</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_features_dict</span><span class="p">[</span><span class="n">feature_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span>

        <span class="n">missing_features</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">req_features</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_features_dict</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">missing_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.name}</span><span class="s2"> lacks features: </span><span class="si">{missing_features}</span><span class="s2">&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Target.get_name"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Target.get_name">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">get_name</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">seqrecord</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get name of target from sequence record.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        seqrecord : Bio.SeqRecord.SeqRecord</span>
<span class="sd">            Sequence record as passed to :class:`Target`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        str</span>
<span class="sd">            Name parsed from `seqrecord`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">seqrecord</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;`seqrecord` does not define a name&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">seqrecord</span><span class="o">.</span><span class="n">name</span></div>

<div class="viewcode-block" id="Target.has_feature"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Target.has_feature">[docs]</a>    <span class="k">def</span> <span class="nf">has_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if a feature is defined for this target.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of :class:`Feature`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            `True` if target has feature of this name, `False` otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features_dict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Target.get_feature"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Target.get_feature">[docs]</a>    <span class="k">def</span> <span class="nf">get_feature</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get :class:`Feature` by name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of :class:`Feature`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`Feature`</span>
<span class="sd">            Returns the feature, or raises `ValueError` if no such feature.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_feature</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;Target </span><span class="si">{self.name}</span><span class="s2"> has no feature </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Target.image"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Target.image">[docs]</a>    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">color_map</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">feature_labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
              <span class="n">plots_indexing</span><span class="o">=</span><span class="s1">&#39;genbank&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get image of the target.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        color_map : None or dict</span>
<span class="sd">            To specify colors for each feature, provide a dict mapping</span>
<span class="sd">            feature names to colors. Otherwise automatically chosen.</span>
<span class="sd">        feature_labels : None or dict</span>
<span class="sd">            Map feature names to text labels shown on plot. Otherwise</span>
<span class="sd">            features just labeled by name.</span>
<span class="sd">        plots_indexing : {&#39;biopython&#39;, &#39;genbank&#39;}</span>
<span class="sd">            Does image use 0-based (&#39;biopython&#39;) or 1-based (&#39;genbank&#39;)</span>
<span class="sd">            indexing of nucleotide sites?</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dna_features_viewer.GraphicRecord.GraphicRecord</span>
<span class="sd">            Image of target, which has `.plot` and `.plot_with_bokeh` methods:</span>
<span class="sd">            https://edinburgh-genome-foundry.github.io/DnaFeaturesViewer</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">color_map</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">CBPALETTE</span><span class="p">):</span>
                <span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">CBPALETTE</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span>
                             <span class="n">i</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span>
                <span class="n">color_map</span> <span class="o">=</span> <span class="p">{</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">matplotlib</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">to_hex</span><span class="p">(</span>
                                           <span class="n">cmap</span><span class="p">(</span><span class="n">i</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)))</span>
                             <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">missing_colors</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span>
                              <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">color_map</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing_colors</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;no `color_map` entry for </span><span class="si">{missing_colors}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">feature_labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">feature_labels</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">feature_labels</span><span class="p">:</span>
                <span class="n">feature_labels</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span>

        <span class="n">graph_features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
            <span class="n">graph_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">dna_features_viewer</span><span class="o">.</span><span class="n">GraphicFeature</span><span class="p">(</span>
                    <span class="n">start</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                    <span class="n">end</span><span class="o">=</span><span class="n">feature</span><span class="o">.</span><span class="n">end</span><span class="p">,</span>
                    <span class="n">label</span><span class="o">=</span><span class="n">feature_labels</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="n">color_map</span><span class="p">[</span><span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                    <span class="n">strand</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="p">)</span>

        <span class="n">graph_record</span> <span class="o">=</span> <span class="n">dna_features_viewer</span><span class="o">.</span><span class="n">GraphicRecord</span><span class="p">(</span>
                <span class="n">sequence_length</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">,</span>
                <span class="n">features</span><span class="o">=</span><span class="n">graph_features</span><span class="p">,</span>
                <span class="n">sequence</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">seq</span><span class="p">,</span>
                <span class="n">plots_indexing</span><span class="o">=</span><span class="n">plots_indexing</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">return</span> <span class="n">graph_record</span></div></div>


<div class="viewcode-block" id="Targets"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Targets">[docs]</a><span class="k">class</span> <span class="nc">Targets</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Collection of :class:`Target` sequences.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    seqsfile : str or list</span>
<span class="sd">        Name of file specifying the targets, or list of such files. So</span>
<span class="sd">        if multiple targets they can all be in one file or in separate files.</span>
<span class="sd">    feature_parse_specs : dict or str</span>
<span class="sd">        How :meth:`Targets.parse_alignment` parses alignments. Specify dict</span>
<span class="sd">        or name of YAML file. Keyed by names of targets, values target-level</span>
<span class="sd">        dicts keyed by feature names. The feature-level dicts have two keys:</span>

<span class="sd">          - &#39;filter&#39;: dict keyed by &#39;clip5&#39;, &#39;clip3&#39;, &#39;mutation_nt_count&#39;,</span>
<span class="sd">            and &#39;mutation_op_count&#39; giving max clipping at each end, number</span>
<span class="sd">            of nucleotide mutations, and number of ``cs`` tag mutation</span>
<span class="sd">            operations allowed for feature. If &#39;filter&#39; itself or any of</span>
<span class="sd">            the keys are missing, the value is set to zero. If the value</span>
<span class="sd">            is `None` (&#39;null&#39; in YAML notation), then no filter is applied.</span>

<span class="sd">          - &#39;return&#39;: str or list of strings indicating what to return for this</span>
<span class="sd">            feature. If &#39;returns&#39; is absent or the value is `None` (&#39;null&#39; in</span>
<span class="sd">            YAML notation), nothing is returned for this feature. Otherwise</span>
<span class="sd">            list one or more of &#39;sequence&#39;, &#39;mutations&#39;, &#39;accuracy&#39;, &#39;cs&#39;,</span>
<span class="sd">            &#39;clip5&#39;, and &#39;clip3&#39; to get the sequence, mutation string, ``cs``</span>
<span class="sd">            tag, or number of clipped nucleotides from each end.</span>

<span class="sd">        In addition, target-level dicts should have keys &#39;query_clip5&#39; and</span>
<span class="sd">        &#39;query_clip3&#39; which give the max amount that can be clipped from</span>
<span class="sd">        each end of the query prior to the alignment. Use a value of</span>
<span class="sd">        `None` (&#39;null&#39; in YAML notation) to have no filter on this clipping.</span>
<span class="sd">        Filters will be applied in the order the features appear in the</span>
<span class="sd">        `feature_parse_specs`.</span>

<span class="sd">    allow_extra_features : bool</span>
<span class="sd">        Can targets have features not in `feature_parse_specs`?</span>
<span class="sd">    seqsfileformat : {&#39;genbank&#39;}</span>
<span class="sd">        Format of `seqsfile`. Currently, &#39;genbank&#39; is the only supported</span>
<span class="sd">        option. The GenBank Flat File format is described `here</span>
<span class="sd">        &lt;https://www.ncbi.nlm.nih.gov/genbank/samplerecord/&gt;`_, but not all</span>
<span class="sd">        fields are required. The documentation includes `examples</span>
<span class="sd">        &lt;https://jbloomlab.github.io/alignparse/examples.html&gt;`_ that show</span>
<span class="sd">        what fields should typically be included. GenBank files can be readily</span>
<span class="sd">        generated using several sequence editing programs, such as `ApE</span>
<span class="sd">        &lt;https://jorgensen.biology.utah.edu/wayned/ape/&gt;`_ or `Benchling</span>
<span class="sd">        &lt;https://www.benchling.com/&gt;`_.</span>
<span class="sd">    allow_clipped_muts_seqs : bool</span>
<span class="sd">        Returning sequence or mutations for features where non-zero</span>
<span class="sd">        clipping is allowed is dangerous, since as described in</span>
<span class="sd">        :meth:`Targets.parse_alignment` these will only be for unclipped</span>
<span class="sd">        region and so are easy to mis-interpret. So you must explicitly</span>
<span class="sd">        set this option to `True` in order to allow return of mutations /</span>
<span class="sd">        sequences for features with clipping allowed; otherwise you&#39;ll get</span>
<span class="sd">        an error if you try to recover such sequences / mutations.</span>
<span class="sd">    ignore_feature_parse_specs_keys : None or list</span>
<span class="sd">        Ignore these target-level keys in `feature_parse_specs`. Useful for</span>
<span class="sd">        YAML with default keys that don&#39;t represent actual targets.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    targets : list</span>
<span class="sd">        List of all :class:`Target` objects.</span>
<span class="sd">    target_names : list</span>
<span class="sd">        List of names of all targets.</span>
<span class="sd">    target_seqs : dict</span>
<span class="sd">        Keyed by target name, value is sequence as str.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get string representation.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self.__class__.__name__}</span><span class="s2">(targets=</span><span class="si">{self.targets}</span><span class="s2">)&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">seqsfile</span><span class="p">,</span> <span class="n">feature_parse_specs</span><span class="p">,</span>
                 <span class="n">allow_extra_features</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">seqsfileformat</span><span class="o">=</span><span class="s1">&#39;genbank&#39;</span><span class="p">,</span>
                 <span class="n">allow_clipped_muts_seqs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                 <span class="n">ignore_feature_parse_specs_keys</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See main class docstring.&quot;&quot;&quot;</span>
        <span class="c1"># read feature_parse_specs</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">feature_parse_specs</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">feature_parse_specs</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">feature_parse_specs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ignore_feature_parse_specs_keys</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">ignore_feature_parse_specs_keys</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="p">:</span>
                    <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;`feature_parse_specs` lacks key </span><span class="si">{key}</span><span class="s2"> &quot;</span>
                                   <span class="s1">&#39;in `ignore_feature_parse_specs_keys`&#39;</span><span class="p">)</span>

        <span class="c1"># names of parse alignment columns with clipping</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clip_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;query_clip5&#39;</span><span class="p">,</span> <span class="s1">&#39;query_clip3&#39;</span><span class="p">]</span>

        <span class="c1"># reserved columns for parsing, cannot be name of a feature</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;query_name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_cols</span>

        <span class="c1"># suffixes in feature columns returned parse_alignment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_return_suffixes</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_mutations&#39;</span><span class="p">,</span> <span class="s1">&#39;_sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;_accuracy&#39;</span><span class="p">,</span> <span class="s1">&#39;_cs&#39;</span><span class="p">,</span>
                                 <span class="s1">&#39;_clip5&#39;</span><span class="p">,</span> <span class="s1">&#39;_clip3&#39;</span><span class="p">]</span>

        <span class="c1"># valid filtering keys</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filterkeys</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;clip5&#39;</span><span class="p">,</span> <span class="s1">&#39;clip3&#39;</span><span class="p">,</span> <span class="s1">&#39;mutation_nt_count&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;mutation_op_count&#39;</span><span class="p">]</span>

        <span class="c1"># get targets from seqsfile</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">seqsfile</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">seqrecords</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Bio</span><span class="o">.</span><span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">seqsfile</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">seqsfileformat</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">seqrecords</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">seqsfile</span><span class="p">:</span>
                <span class="n">seqrecords</span> <span class="o">+=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Bio</span><span class="o">.</span><span class="n">SeqIO</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="n">seqsfileformat</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">targets</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_target_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">seqrecord</span> <span class="ow">in</span> <span class="n">seqrecords</span><span class="p">:</span>
            <span class="n">tname</span> <span class="o">=</span> <span class="n">Target</span><span class="o">.</span><span class="n">get_name</span><span class="p">(</span><span class="n">seqrecord</span><span class="p">)</span>
            <span class="n">target</span> <span class="o">=</span> <span class="n">Target</span><span class="p">(</span><span class="n">seqrecord</span><span class="o">=</span><span class="n">seqrecord</span><span class="p">,</span>
                            <span class="n">req_features</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">features_to_parse</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">),</span>
                            <span class="n">allow_extra_features</span><span class="o">=</span><span class="n">allow_extra_features</span><span class="p">,</span>
                            <span class="p">)</span>
            <span class="k">if</span> <span class="n">target</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_dict</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;duplicate target name of </span><span class="si">{target.name}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_target_dict</span><span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">target</span>
            <span class="c1"># ensure feature names are not reserved or have reserved suffix</span>
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">target</span><span class="o">.</span><span class="n">features</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_cols</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;feature cannot be named </span><span class="si">{feature.name}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;|&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="s1">&#39;$&#39;</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_suffixes</span><span class="p">),</span>
                             <span class="n">feature</span><span class="o">.</span><span class="n">name</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;feature name cannot end in &#39;</span> <span class="o">+</span>
                                     <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_return_suffixes</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">target_seqs</span> <span class="o">=</span> <span class="p">{</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">target</span><span class="o">.</span><span class="n">seq</span> <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">}</span>

        <span class="c1"># check needed for `to_csv` option of `parse_alignment`.</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">({</span><span class="n">tname</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="k">for</span>
                                         <span class="n">tname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;target names must be unique even after &#39;</span>
                             <span class="s1">&#39;replacing spaces with underscores.&#39;</span><span class="p">)</span>

        <span class="c1"># make sure we have all targets to parse</span>
        <span class="n">extra_targets</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_targets</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`feature_parse_specs` includes non-existent &#39;</span>
                             <span class="n">f</span><span class="s2">&quot;targets </span><span class="si">{extra_targets}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_feature_parse_specs_defaults</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_parse_filters</span><span class="p">()</span>

        <span class="c1"># check we are not set to return sequence / mutations for clipped</span>
        <span class="c1"># features unless flag to do this explicitly set</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_clipped_muts_seqs</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_to_parse</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">return_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;sequence&#39;</span><span class="p">,</span> <span class="s1">&#39;mutations&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">return_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_returnvals</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
                            <span class="n">filt</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_filters</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">f</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">filt</span> <span class="ow">or</span> <span class="n">filt</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span>
                                       <span class="p">[</span><span class="s1">&#39;clip5&#39;</span><span class="p">,</span> <span class="s1">&#39;clip3&#39;</span><span class="p">])):</span>
                                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                        <span class="n">f</span><span class="s2">&quot;You asked to return </span><span class="si">{return_name}</span><span class="s2"> &quot;</span>
                                        <span class="n">f</span><span class="s2">&quot;for </span><span class="si">{t}</span><span class="s2">, </span><span class="si">{f}</span><span class="s2">, but clipping is not &quot;</span>
                                        <span class="s1">&#39;0 for this feature. To do this, set&#39;</span>
                                        <span class="s1">&#39;`allow_clipped_muts_seqs` to `True`&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_parse_filters</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set `_parse_filters` attribute.</span>

<span class="sd">        This is dict keyed by targetname, then keyed by feature name,</span>
<span class="sd">        then keyed by each parameter to filter on with value being</span>
<span class="sd">        max allowed. If the value is `None` (no filter), it is not in dict.</span>

<span class="sd">        This is a simpler-to-access version of information in</span>
<span class="sd">        `feature_parse_specs`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_filters</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">tname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_parse_filters</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_to_parse</span><span class="p">(</span><span class="n">tname</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_parse_filters</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">filterspecs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span><span class="p">][</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">filterspecs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`feature_parse_spec` filter for&#39;</span>
                                             <span class="n">f</span><span class="s2">&quot; </span><span class="si">{tname}</span><span class="s2">, </span><span class="si">{fname}</span><span class="s2">, </span><span class="si">{k}</span><span class="s2"> is not &quot;</span>
                                             <span class="n">f</span><span class="s2">&quot;`None` or an integer: </span><span class="si">{v}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_parse_filters</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">_set_feature_parse_specs_defaults</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set missing values in `feature_parse_specs` to defaults.</span>

<span class="sd">        These defaults are described in the main :class:`Targets` docs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">tspecs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_clip_cols</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="n">tspecs</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;`feature_parse_specs` for </span><span class="si">{tname}</span><span class="s2"> &quot;</span>
                                 <span class="n">f</span><span class="s2">&quot;lacks </span><span class="si">{self._clip_cols}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">fname</span><span class="p">,</span> <span class="n">fdict</span> <span class="ow">in</span> <span class="n">tspecs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">fname</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_cols</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">fdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="p">{</span><span class="s1">&#39;return&#39;</span><span class="p">,</span> <span class="s1">&#39;filter&#39;</span><span class="p">}:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;`feature_parse_specs` for </span><span class="si">{tname}</span><span class="s2"> &quot;</span>
                                     <span class="n">f</span><span class="s2">&quot;</span><span class="si">{fname}</span><span class="s2"> has extra keys: only &#39;return&#39; &quot;</span>
                                     <span class="s2">&quot;and &#39;filter&#39; are allowed.&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;return&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fdict</span><span class="p">:</span>
                    <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]]</span>
                    <span class="k">for</span> <span class="n">returnval</span> <span class="ow">in</span> <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;return&#39;</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">returnval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="n">suffix</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">_return_suffixes</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                    <span class="n">f</span><span class="s2">&quot;`feature_parse_specs` of </span><span class="si">{tname}</span><span class="s2"> </span><span class="si">{fname}</span><span class="s2">&quot;</span>
                                    <span class="n">f</span><span class="s2">&quot; has invalid return type </span><span class="si">{returnval}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s1">&#39;filter&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fdict</span><span class="p">:</span>
                    <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">-</span> <span class="nb">set</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filterkeys</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;`feature_parse_specs` for </span><span class="si">{tname}</span><span class="s2"> &quot;</span>
                                     <span class="n">f</span><span class="s2">&quot;</span><span class="si">{fname}</span><span class="s2"> has invalid filter type. Only &quot;</span>
                                     <span class="n">f</span><span class="s2">&quot;</span><span class="si">{self._filterkeys}</span><span class="s2"> are allowed.&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">filterkey</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filterkeys</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filterkey</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">]:</span>
                        <span class="n">fdict</span><span class="p">[</span><span class="s1">&#39;filter&#39;</span><span class="p">][</span><span class="n">filterkey</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<div class="viewcode-block" id="Targets.features_to_parse"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Targets.features_to_parse">[docs]</a>    <span class="k">def</span> <span class="nf">features_to_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetname</span><span class="p">,</span> <span class="n">feature_or_name</span><span class="o">=</span><span class="s1">&#39;feature&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Features to parse for a target.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        targetname : str</span>
<span class="sd">            Name of target.</span>
<span class="sd">        feature_or_name : {&#39;feature&#39;, &#39;name&#39;}</span>
<span class="sd">            Get the :class:`Feature` objects themselves or their names.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            Features to parse for this target, as specified in</span>
<span class="sd">            :meth:`Targets.feature_parse_specs`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">feature_or_name</span> <span class="o">==</span> <span class="s1">&#39;name&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_fnames_to_parse&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_fnames_to_parse</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">tdict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_fnames_to_parse</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tdict</span> <span class="k">if</span>
                                                    <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_cols</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fnames_to_parse</span><span class="p">[</span><span class="n">targetname</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;target </span><span class="si">{targetname}</span><span class="s2"> not in &quot;</span>
                                 <span class="s1">&#39;`feature_parse_specs`&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">feature_or_name</span> <span class="o">==</span> <span class="s1">&#39;feature&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_features_to_parse&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_features_to_parse</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="k">for</span> <span class="n">tname</span><span class="p">,</span> <span class="n">tdict</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_target</span><span class="p">(</span><span class="n">tname</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_features_to_parse</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">target</span><span class="o">.</span><span class="n">get_feature</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
                                                      <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">tdict</span> <span class="k">if</span>
                                                      <span class="n">f</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_clip_cols</span><span class="p">]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_features_to_parse</span><span class="p">[</span><span class="n">targetname</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;target </span><span class="si">{targetname}</span><span class="s2"> not in &quot;</span>
                                 <span class="s1">&#39;`feature_parse_specs`&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;invalid `feature_or_name` </span><span class="si">{feature_or_name}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Targets.feature_parse_specs"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Targets.feature_parse_specs">[docs]</a>    <span class="k">def</span> <span class="nf">feature_parse_specs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">returntype</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the feature parsing specs.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Filters will be applied in the order they are listed in the</span>
<span class="sd">        `feature_parse_specs` `yaml` file or `dict`. Once a read fails a</span>
<span class="sd">        filter, other filters will not be applied. As such, it is recommended</span>
<span class="sd">        to have features with filters for 5&#39; and 3&#39; clipping listed first.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        returntype : {&#39;dict&#39;, &#39;yaml&#39;}</span>
<span class="sd">            Return a Python `dict` or a YAML string representation.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict or str</span>
<span class="sd">            The feature parsing specs set by the `feature_parse_specs` at</span>
<span class="sd">            :class:`Targets` initialization, but with any missing default</span>
<span class="sd">            values explicitly filled in.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">returntype</span> <span class="o">==</span> <span class="s1">&#39;dict&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">returntype</span> <span class="o">==</span> <span class="s1">&#39;yaml&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="p">,</span>
                             <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                             <span class="n">sort_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;invalid `returntype` of </span><span class="si">{returntype}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Targets.get_target"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Targets.get_target">[docs]</a>    <span class="k">def</span> <span class="nf">get_target</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get :class:`Target` by name.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        name : str</span>
<span class="sd">            Name of :class:`Target`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        :class:`Target`</span>
<span class="sd">            Returns the target, or raises `ValueError` if no such target.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_dict</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_target_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;no target named </span><span class="si">{name}</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Targets.write_fasta"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Targets.write_fasta">[docs]</a>    <span class="k">def</span> <span class="nf">write_fasta</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fastafile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write all targets to a FASTA file.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filename : str or writable file-like object</span>
<span class="sd">            Write targets to this file.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
                <span class="n">fastafile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&gt;</span><span class="si">{target.name}</span><span class="se">\n</span><span class="si">{target.seq}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">fastafile</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fastafile</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;&gt;</span><span class="si">{target.name}</span><span class="se">\n</span><span class="si">{target.seq}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="Targets.plot"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Targets.plot">[docs]</a>    <span class="k">def</span> <span class="nf">plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax_width</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">ax_height</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot all the targets.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        For more customizable plots, call :meth:`Target.image` for individual</span>
<span class="sd">        targets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        sharex : bool</span>
<span class="sd">            Share x-axis among plots for each target?</span>
<span class="sd">        ax_width : float</span>
<span class="sd">            Width of each axis in inches.</span>
<span class="sd">        ax_height : float</span>
<span class="sd">            Height of each axis in inches.</span>
<span class="sd">        ``**kwargs``</span>
<span class="sd">            Keyword arguments passed to :meth:`Target.image`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        matplotlib.pyplot.figure</span>
<span class="sd">            Figure showing all targets.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">nrows</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">),</span>
                                 <span class="n">ncols</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                 <span class="n">sharex</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">squeeze</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                 <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;hspace&#39;</span><span class="p">:</span> <span class="mf">0.4</span><span class="p">},</span>
                                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="n">ax_width</span><span class="p">,</span>
                                          <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">)</span> <span class="o">*</span> <span class="n">ax_height</span><span class="p">),</span>
                                 <span class="p">)</span>
        <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">targets</span><span class="p">):</span>
            <span class="n">image</span> <span class="o">=</span> <span class="n">target</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">image</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">fig</span></div>

<div class="viewcode-block" id="Targets.align"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Targets.align">[docs]</a>    <span class="k">def</span> <span class="nf">align</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">queryfile</span><span class="p">,</span> <span class="n">alignmentfile</span><span class="p">,</span> <span class="n">mapper</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Align query sequences to targets.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        queryfile : str</span>
<span class="sd">            The query sequences to align (FASTQ or FASTA, can be gzipped).</span>
<span class="sd">        alignmentfile : str</span>
<span class="sd">            SAM file created by `mapper` with alignments of queries to the</span>
<span class="sd">            target sequences within this :class:`Targets` object.</span>
<span class="sd">        mapper : :class:`alignparse.minimap2.Mapper`</span>
<span class="sd">            Mapper that runs ``minimap2``. Alignment options set when creating</span>
<span class="sd">            this mapper.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.fa&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">targetfile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">write_fasta</span><span class="p">(</span><span class="n">targetfile</span><span class="p">)</span>
            <span class="n">mapper</span><span class="o">.</span><span class="n">map_to_sam</span><span class="p">(</span><span class="n">targetfile</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">queryfile</span><span class="p">,</span> <span class="n">alignmentfile</span><span class="p">)</span></div>

<div class="viewcode-block" id="Targets.align_and_parse"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Targets.align_and_parse">[docs]</a>    <span class="k">def</span> <span class="nf">align_and_parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                        <span class="n">df</span><span class="p">,</span>
                        <span class="n">mapper</span><span class="p">,</span>
                        <span class="n">outdir</span><span class="p">,</span>
                        <span class="o">*</span><span class="p">,</span>
                        <span class="n">name_col</span><span class="o">=</span><span class="s1">&#39;name&#39;</span><span class="p">,</span>
                        <span class="n">queryfile_col</span><span class="o">=</span><span class="s1">&#39;queryfile&#39;</span><span class="p">,</span>
                        <span class="n">group_cols</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">to_csv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">multi_align</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span>
                        <span class="n">filtered_cs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">skip_sups</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">ncpus</span><span class="o">=-</span><span class="mi">1</span>
                        <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Align query sequences and then parse alignments.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This is a convenience method to run :meth:`Targets.align` and</span>
<span class="sd">        :meth:`Targets.parse_alignment` on multiple queries and collate</span>
<span class="sd">        the results.</span>

<span class="sd">        It also allows multiple queries to be handled simultaneously using</span>
<span class="sd">        multiprocessing.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        df : pandas.DataFrame</span>
<span class="sd">            Data frame with information on queries to align.</span>
<span class="sd">        mapper : :class:`alignparse.minimap2.Mapper`</span>
<span class="sd">            Mapper that runs ``minimap2``. Alignment options set when creating</span>
<span class="sd">            this mapper.</span>
<span class="sd">        outdir : str</span>
<span class="sd">            Name of directory with created alignments and parsing files.</span>
<span class="sd">            Created if it does not exist.</span>
<span class="sd">        name_col : str</span>
<span class="sd">            Column in `df` with the name of each set of queries.</span>
<span class="sd">        queryfile_col :str</span>
<span class="sd">            Column in `df` with FASTQ file with queries.</span>
<span class="sd">        group_cols : `None` or str or list</span>
<span class="sd">            Columns in `df` used to &quot;group&quot; results. These columns are</span>
<span class="sd">            in all created data frames. For instance, might specify</span>
<span class="sd">            different libraries or samples.</span>
<span class="sd">        to_csv : bool</span>
<span class="sd">            Write CSV files rather than return data frames. Useful to</span>
<span class="sd">            avoid reading large data frames into memory.</span>
<span class="sd">        overwrite : bool</span>
<span class="sd">            If some of the created output files already exist, do we</span>
<span class="sd">            overwrite them or raise and error?</span>
<span class="sd">        multi_align : {&#39;primary&#39;}</span>
<span class="sd">            How to handle multiple alignments. Currently only option is</span>
<span class="sd">            &#39;primary&#39;, which ignores all secondary alignments.</span>
<span class="sd">        filtered_cs : bool</span>
<span class="sd">            Add `cs` tag that failed the filter to filtered dataframe along</span>
<span class="sd">            with filter reason. Allows for more easily investigating why</span>
<span class="sd">            reads are failing the filters.</span>
<span class="sd">        skip_sups : bool</span>
<span class="sd">            Whether or not to skip supplementary alignments when parsing.</span>
<span class="sd">            Supplementary alignments are additional possible alignments for</span>
<span class="sd">            a read due to the read potentially being a chimeric. The default</span>
<span class="sd">            is to skip these alignments and *not* parse them.</span>
<span class="sd">        ncpus : int</span>
<span class="sd">            Number of CPUs to use; -1 means all available.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (readstats, aligned, filtered) : tuple</span>
<span class="sd">            Same meaning as for :meth:`Targets.parse_alignments` except</span>
<span class="sd">            the data frames / CSV files all have additional columns indicating</span>
<span class="sd">            name of each query set (`name_cols`) as well as any `group_cols`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># check columns in `df`</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">group_cols</span><span class="p">:</span>
            <span class="n">addtl_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_col</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_cols</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="n">group_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">group_cols</span><span class="p">]</span>
            <span class="n">addtl_cols</span> <span class="o">=</span> <span class="n">group_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">name_col</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">addtl_cols</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">addtl_cols</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`name_col` and `group_cols` have redundant &#39;</span>
                                 <span class="n">f</span><span class="s2">&quot;entries: </span><span class="si">{addtl_cols}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">expected_cols</span> <span class="o">=</span> <span class="n">addtl_cols</span> <span class="o">+</span> <span class="p">[</span><span class="n">queryfile_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">set</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span><span class="o">.</span><span class="n">issuperset</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">expected_cols</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`df` does not contain all expected columns: &#39;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">expected_cols</span><span class="p">))</span>

        <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># For each query we create a &quot;full name&quot; that includes name +</span>
        <span class="c1"># grouping cols, a subdirectory that holds all files</span>
        <span class="c1"># for this query, and the samfile for the alignments.</span>
        <span class="n">reserved_cols</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fullname&#39;</span><span class="p">,</span> <span class="s1">&#39;subdir&#39;</span><span class="p">,</span> <span class="s1">&#39;samfile&#39;</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">expected_cols</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">reserved_cols</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;`df` cannot have columns: </span><span class="si">{reserved_cols}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span>
            <span class="p">[</span><span class="n">expected_cols</span><span class="p">]</span>
            <span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">fullname</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span>
                                                              <span class="ow">in</span> <span class="n">addtl_cols</span><span class="p">),</span>
                                           <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                <span class="n">subdir</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;fullname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">n</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                   <span class="n">outdir</span><span class="p">,</span> <span class="n">n</span><span class="p">)),</span>
                <span class="n">samfile</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;subdir&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                                                  <span class="n">d</span><span class="p">,</span> <span class="s1">&#39;alignments.sam&#39;</span><span class="p">)),</span>
                <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">!=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;fullname&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">nunique</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Names the queries are not unique even after &#39;</span>
                             <span class="s1">&#39;adding grouping columns.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`name_col` and `group_cols` entry contains &quot;,&quot;&#39;</span><span class="p">)</span>

        <span class="c1"># set up multiprocessing pool</span>
        <span class="k">if</span> <span class="n">ncpus</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="n">pathos</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pathos</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="n">ncpus</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncpus</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`ncpus` must be &gt;= 1&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">pathos</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">ProcessPool</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)</span>
            <span class="n">map_func</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">map_func</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">argtup</span><span class="p">)</span> <span class="k">for</span> <span class="n">argtup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)]</span>

        <span class="c1"># now make the alignments</span>
        <span class="k">for</span> <span class="n">tup</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">itertuples</span><span class="p">():</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">tup</span><span class="o">.</span><span class="n">subdir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">tup</span><span class="o">.</span><span class="n">samfile</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">overwrite</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tup</span><span class="o">.</span><span class="n">samfile</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;file </span><span class="si">{tup.samfile}</span><span class="s2"> already exists&quot;</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">map_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">align</span><span class="p">,</span>
                     <span class="n">df</span><span class="p">[</span><span class="n">queryfile_col</span><span class="p">],</span>
                     <span class="n">df</span><span class="p">[</span><span class="s1">&#39;samfile&#39;</span><span class="p">],</span>
                     <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mapper</span><span class="p">))</span>
        <span class="k">assert</span> <span class="nb">all</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;samfile&#39;</span><span class="p">])</span>

        <span class="c1"># now parse the alignments</span>
        <span class="n">parse_results</span> <span class="o">=</span> <span class="n">map_func</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_alignment</span><span class="p">,</span>
                                 <span class="n">df</span><span class="p">[</span><span class="s1">&#39;samfile&#39;</span><span class="p">],</span>
                                 <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">multi_align</span><span class="p">),</span>
                                 <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">True</span><span class="p">),</span>
                                 <span class="n">df</span><span class="p">[</span><span class="s1">&#39;subdir&#39;</span><span class="p">],</span>
                                 <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">overwrite</span><span class="p">),</span>
                                 <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">filtered_cs</span><span class="p">),</span>
                                 <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">skip_sups</span><span class="p">)</span>
                                 <span class="p">)</span>

        <span class="c1"># close, clear pool: https://github.com/uqfoundation/pathos/issues/111</span>
        <span class="k">if</span> <span class="n">ncpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

        <span class="c1"># Set up to gather overall readstats, aligned, and filtered by</span>
        <span class="c1"># getting and checking column names:</span>
        <span class="n">readstatcols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]</span>
        <span class="n">alignedcols</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_returnvals</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}</span>
        <span class="n">filteredcols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;query_name&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_reason&#39;</span><span class="p">]</span>
        <span class="n">disallowedcols</span> <span class="o">=</span> <span class="n">readstatcols</span> <span class="o">+</span> <span class="n">filteredcols</span>
        <span class="k">for</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">alignedcols</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">disallowedcols</span> <span class="o">+=</span> <span class="n">tc</span>
        <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">addtl_cols</span><span class="p">)</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">disallowedcols</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;`name_col`, `group_cols` cannot have any of &#39;</span> <span class="o">+</span>
                             <span class="nb">str</span><span class="p">(</span><span class="n">disallowedcols</span><span class="p">))</span>
        <span class="n">alignedcols</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">addtl_cols</span> <span class="o">+</span> <span class="n">tc</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tc</span> <span class="ow">in</span> <span class="n">alignedcols</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="n">filteredcols</span> <span class="o">=</span> <span class="n">addtl_cols</span> <span class="o">+</span> <span class="n">filteredcols</span>

        <span class="c1"># set up data frames or names of files</span>
        <span class="n">readstats</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([],</span> <span class="n">columns</span><span class="o">=</span><span class="n">addtl_cols</span> <span class="o">+</span> <span class="n">readstatcols</span><span class="p">)</span>
        <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span>
                                    <span class="s1">&#39;_filtered.csv&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}</span>
        <span class="n">aligned</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">outdir</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span>
                                   <span class="s1">&#39;_aligned.csv&#39;</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">aligned</span><span class="o">.</span><span class="n">values</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;file </span><span class="si">{f}</span><span class="s2"> already exists.&quot;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

        <span class="c1"># collect read stats for all runs</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ireadstats</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parse_results</span><span class="p">):</span>
            <span class="n">readstats</span> <span class="o">=</span> <span class="n">readstats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                    <span class="p">(</span><span class="n">ireadstats</span>
                     <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">addtl_cols</span><span class="p">})</span>
                     <span class="p">[</span><span class="n">readstats</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
                     <span class="p">),</span>
                    <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">)</span>
        <span class="n">readstats</span> <span class="o">=</span> <span class="n">readstats</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">count</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

        <span class="c1"># collect aligned and filtered for all runs</span>
        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">:</span>
            <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
                <span class="c1"># Define callback to delete CSV files on error. See here:</span>
                <span class="c1"># https://docs.python.org/3/library/contextlib.html#replacing-any-use-of-try-finally-and-flag-variables</span>
                <span class="nd">@stack</span><span class="o">.</span><span class="n">callback</span>
                <span class="k">def</span> <span class="nf">delete_files_on_err</span><span class="p">():</span>
                    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="p">[</span><span class="n">aligned</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">filtered</span><span class="p">[</span><span class="n">t</span><span class="p">]]:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

                <span class="n">alignedfile</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">aligned</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
                <span class="n">filteredfile</span> <span class="o">=</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">filtered</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
                <span class="n">alignedfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">alignedcols</span><span class="p">[</span><span class="n">t</span><span class="p">])</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">filteredfile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filteredcols</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">ialigned</span><span class="p">,</span> <span class="n">ifiltered</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">parse_results</span><span class="p">):</span>
                    <span class="n">addtl_text</span> <span class="o">=</span> <span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">at</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">addtl_cols</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">fin_name</span><span class="p">,</span> <span class="n">fout</span><span class="p">,</span> <span class="n">cols</span> <span class="ow">in</span> <span class="p">[</span>
                            <span class="p">(</span><span class="n">ialigned</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">alignedfile</span><span class="p">,</span> <span class="n">alignedcols</span><span class="p">[</span><span class="n">t</span><span class="p">]),</span>
                            <span class="p">(</span><span class="n">ifiltered</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">filteredfile</span><span class="p">,</span> <span class="n">filteredcols</span><span class="p">),</span>
                            <span class="p">]:</span>
                        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">fin_name</span><span class="p">)</span> <span class="k">as</span> <span class="n">fin</span><span class="p">:</span>
                            <span class="n">firstline</span> <span class="o">=</span> <span class="n">fin</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                            <span class="k">assert</span> <span class="p">(</span><span class="n">firstline</span><span class="p">[:</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span> <span class="o">==</span>
                                    <span class="n">cols</span><span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">addtl_cols</span><span class="p">):]),</span> <span class="n">fin_name</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fin</span><span class="p">:</span>
                                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">addtl_text</span><span class="p">)</span>
                                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="p">)</span>
                                <span class="n">fout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                            <span class="n">fout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

                <span class="n">stack</span><span class="o">.</span><span class="n">pop_all</span><span class="p">()</span>  <span class="c1"># no callback to delete files if reached here</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">to_csv</span><span class="p">:</span>
            <span class="n">aligned</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aligned</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">f</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filtered</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

        <span class="k">return</span> <span class="n">readstats</span><span class="p">,</span> <span class="n">aligned</span><span class="p">,</span> <span class="n">filtered</span></div>

<div class="viewcode-block" id="Targets.parse_alignment"><a class="viewcode-back" href="../../alignparse.targets.html#alignparse.targets.Targets.parse_alignment">[docs]</a>    <span class="k">def</span> <span class="nf">parse_alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samfile</span><span class="p">,</span> <span class="n">multi_align</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span>
                        <span class="n">to_csv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">csv_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">overwrite_csv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">filtered_cs</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">skip_sups</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse alignment features as specified in `feature_parse_specs`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        samfile : str</span>
<span class="sd">            SAM file with ``minimap2`` alignments with ``cs`` tag, typically</span>
<span class="sd">            created by :meth:`Targets.align`.</span>
<span class="sd">        multi_align : {&#39;primary&#39;}</span>
<span class="sd">            How to handle multiple alignments. Currently only option is</span>
<span class="sd">            &#39;primary&#39;, which ignores all secondary alignments.</span>
<span class="sd">        to_csv : bool</span>
<span class="sd">            Return CSV file names rather than return data frames. Useful to</span>
<span class="sd">            avoid reading large data frames into memory.</span>
<span class="sd">        csv_dir : None or str</span>
<span class="sd">            If `to_csv` is `True`, name of directory to which we</span>
<span class="sd">            write CSV files (created if needed). If `None`, write</span>
<span class="sd">            to current directory.</span>
<span class="sd">        overwrite_csv : bool</span>
<span class="sd">            If using `to_csv`, do we overwrite existing CSV files or</span>
<span class="sd">            raise an error if they already exist?</span>
<span class="sd">        filtered_cs : bool</span>
<span class="sd">            Add `cs` tag that failed the filter to filtered dataframe along</span>
<span class="sd">            with filter reason. Allows for more easily investigating why</span>
<span class="sd">            reads are failing the filters.</span>
<span class="sd">        skip_sups : bool</span>
<span class="sd">            Whether or not to skip supplementary alignments when parsing.</span>
<span class="sd">            Supplementary alignments are additional possible alignments for</span>
<span class="sd">            a read due to the read potentially being a chimeric. The default</span>
<span class="sd">            is to skip these alignments and *not* parse them.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        (readstats, aligned, filtered) : tuple</span>

<span class="sd">            - `readstats` is `pandas.DataFrame` with numbers of unmapped reads,</span>
<span class="sd">              and for each target the number of mapped reads that are validly</span>
<span class="sd">              aligned and that fail filters in `feature_parse_specs`.</span>

<span class="sd">            - `aligned` is a dict keyed by name of each target. Entries are</span>
<span class="sd">              `pandas.DataFrame` with rows for each validly aligned read. Rows</span>
<span class="sd">              give query name, query clipping at each end of alignment, and any</span>
<span class="sd">              feature-level info specified for return in `feature_parse_specs`</span>
<span class="sd">              in columns with names equal to feature suffixed by &#39;_sequence&#39;,</span>
<span class="sd">              &#39;_mutations&#39;, &#39;_accuracy&#39;, &#39;_cs&#39;, &#39;_clip5&#39;, and &#39;_clip3&#39;.</span>
<span class="sd">              and &#39;_clip3&#39;.</span>

<span class="sd">            - `filtered` is a dict keyed by name of each target. Entries are</span>
<span class="sd">              `pandas.DataFrame` with a row for each filtered aligned read</span>
<span class="sd">              giving the query name and the reason it was filtered.</span>
<span class="sd">              If `filtered_cs` is `True` then, add a column to the &quot;filtered&quot;</span>
<span class="sd">              `pandas.DataFrame`s with the `cs` tag that failed the filter.</span>

<span class="sd">            If `to_csv` is `True`, then `aligned` and `filtered` give</span>
<span class="sd">            names of CSV files holding data frames.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        The ``cs`` tags are in the short format returned by ``minimap2``;</span>
<span class="sd">        see here for details: https://lh3.github.io/minimap2/minimap2.html</span>

<span class="sd">        When parsing features, if an insertion occurs between two features,</span>
<span class="sd">        it is assigned to the end of the first feature.</span>

<span class="sd">        Returned sequences, mutation strings, and ``cs`` tags are only for</span>
<span class="sd">        for the portion of the feature that aligns, and do **not** indicate</span>
<span class="sd">        clipping, which you instead get in the &#39;_clip*&#39; columns. The</span>
<span class="sd">        sequences are simply what the ``cs`` tag implies, indels / mutations</span>
<span class="sd">        are not indicated in this column. Mutation strings are space-delimited</span>
<span class="sd">        with these operations in **1-based** (1, 2, ...) numbering from start</span>
<span class="sd">        of the feature:</span>

<span class="sd">          - &#39;A2G&#39; : substitution at site 2 from A to G</span>

<span class="sd">          - &#39;ins5TAA&#39; : insertion of &#39;TAA&#39; starting at site 5</span>

<span class="sd">          - &#39;del5to6&#39; : deletion of sites 5 to 6, inclusive</span>

<span class="sd">        The returned accuracy is the average accuracy of the aligned</span>
<span class="sd">        query sites as calculated from the Q-values, and is `nan` if</span>
<span class="sd">        there are no aligned query sites.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">multi_align</span> <span class="o">==</span> <span class="s1">&#39;primary&#39;</span><span class="p">:</span>
            <span class="n">primary_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;invalid `multi_align` </span><span class="si">{multi_align}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">csv_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">csv_dir</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">elif</span> <span class="n">csv_dir</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">csv_dir</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">unmapped</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">readstats</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="p">{</span><span class="s1">&#39;filtered&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;aligned&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">}</span>
                     <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}</span>

        <span class="k">if</span> <span class="n">filtered_cs</span><span class="p">:</span>
            <span class="n">filtered_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;query_name&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_reason&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_cs&#39;</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filtered_cols</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;query_name&#39;</span><span class="p">,</span> <span class="s1">&#39;filter_reason&#39;</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">to_csv</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csv_dir</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span>
                                        <span class="s1">&#39;_filtered.csv&#39;</span><span class="p">)</span>
                        <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}</span>
            <span class="n">aligned</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">csv_dir</span><span class="p">,</span> <span class="n">t</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;_&#39;</span><span class="p">)</span> <span class="o">+</span>
                                       <span class="s1">&#39;_aligned.csv&#39;</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}</span>
            <span class="n">filenames</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">filtered</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">aligned</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">overwrite_csv</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">any</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">,</span> <span class="n">filenames</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;existing file with name in: </span><span class="si">{filenames}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}</span>
            <span class="n">aligned</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}</span>

        <span class="c1"># Iterate samfile in contextlib so can handle files if using `to_csv`.</span>
        <span class="k">with</span> <span class="n">contextlib</span><span class="o">.</span><span class="n">ExitStack</span><span class="p">()</span> <span class="k">as</span> <span class="n">stack</span><span class="p">:</span>
            <span class="c1"># Define callback to delete CSV files on error. See here:</span>
            <span class="c1"># https://docs.python.org/3/library/contextlib.html#replacing-any-use-of-try-finally-and-flag-variables</span>
            <span class="nd">@stack</span><span class="o">.</span><span class="n">callback</span>
            <span class="k">def</span> <span class="nf">delete_files_on_err</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">to_csv</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">fname</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fname</span><span class="p">):</span>
                            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">to_csv</span><span class="p">:</span>
                <span class="c1"># add files to stack so they are closed at end:</span>
                <span class="c1"># https://stackoverflow.com/a/19412700</span>
                <span class="n">filtered_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
                                  <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filtered</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filtered_files</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">filtered_cols</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                <span class="n">aligned_files</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">stack</span><span class="o">.</span><span class="n">enter_context</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span>
                                 <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aligned</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">aligned_files</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_returnvals</span><span class="p">(</span><span class="n">t</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

            <span class="c1"># iterate over samfile and process each alignment</span>
            <span class="k">for</span> <span class="n">aligned_seg</span> <span class="ow">in</span> <span class="n">pysam</span><span class="o">.</span><span class="n">AlignmentFile</span><span class="p">(</span><span class="n">samfile</span><span class="p">):</span>

                <span class="k">if</span> <span class="n">aligned_seg</span><span class="o">.</span><span class="n">is_unmapped</span><span class="p">:</span>
                    <span class="n">unmapped</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">aligned_seg</span><span class="o">.</span><span class="n">is_supplementary</span> <span class="ow">and</span> <span class="n">skip_sups</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">aligned_seg</span><span class="o">.</span><span class="n">is_secondary</span> <span class="ow">and</span> <span class="n">primary_only</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="n">a</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">aligned_seg</span><span class="p">,</span> <span class="n">introns_to_deletions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">target_seqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_seqs</span><span class="p">)</span>
                <span class="n">tname</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">target_name</span>

                <span class="n">is_filtered</span><span class="p">,</span> <span class="n">parse_tup</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_single_Alignment</span><span class="p">(</span>
                                                                <span class="n">a</span><span class="p">,</span>
                                                                <span class="n">tname</span><span class="p">,</span>
                                                                <span class="n">filtered_cs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_filtered</span><span class="p">:</span>
                    <span class="n">readstats</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="s1">&#39;filtered&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">to_csv</span><span class="p">:</span>
                        <span class="n">filtered_files</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span>
                                                                 <span class="n">parse_tup</span><span class="p">)))</span>
                        <span class="n">filtered_files</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">filtered</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_tup</span><span class="p">)</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">readstats</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="s1">&#39;aligned&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="n">to_csv</span><span class="p">:</span>
                        <span class="n">aligned_files</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;,&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span>
                                                                <span class="n">parse_tup</span><span class="p">)))</span>
                        <span class="n">aligned_files</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">aligned</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">parse_tup</span><span class="p">)</span>

            <span class="c1"># Done iterating over `samfile`, get values ready to return</span>
            <span class="n">readstats</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">readstats</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                         <span class="o">.</span><span class="n">melt</span><span class="p">(</span><span class="n">id_vars</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">value_name</span><span class="o">=</span><span class="s1">&#39;count&#39;</span><span class="p">)</span>
                         <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">category</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span> <span class="o">+</span>
                                                     <span class="n">x</span><span class="p">[</span><span class="s1">&#39;variable&#39;</span><span class="p">]))</span>
                         <span class="p">[[</span><span class="s1">&#39;category&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">]]</span>
                         <span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;category&#39;</span><span class="p">:</span> <span class="s1">&#39;unmapped&#39;</span><span class="p">,</span> <span class="s1">&#39;count&#39;</span><span class="p">:</span> <span class="n">unmapped</span><span class="p">},</span>
                                 <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                         <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">to_csv</span><span class="p">:</span>
                <span class="n">filtered</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">filtered_cols</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tlist</span> <span class="ow">in</span> <span class="n">filtered</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
                <span class="n">aligned</span> <span class="o">=</span> <span class="p">{</span><span class="n">t</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">tlist</span><span class="p">,</span>
                                           <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_parse_returnvals</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                           <span class="k">for</span> <span class="n">t</span><span class="p">,</span> <span class="n">tlist</span> <span class="ow">in</span> <span class="n">aligned</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">aligned_files</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="o">+</span>
                          <span class="nb">list</span><span class="p">(</span><span class="n">filtered_files</span><span class="o">.</span><span class="n">values</span><span class="p">())):</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

            <span class="n">stack</span><span class="o">.</span><span class="n">pop_all</span><span class="p">()</span>  <span class="c1"># no callback to delete CSV files if reached here</span>

        <span class="k">return</span> <span class="n">readstats</span><span class="p">,</span> <span class="n">aligned</span><span class="p">,</span> <span class="n">filtered</span></div>

    <span class="k">def</span> <span class="nf">_parse_returnvals</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetname</span><span class="p">,</span> <span class="n">featurename</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Values to return when parsing alignment.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        targetname : str</span>
<span class="sd">        featurename : str or None</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list</span>
<span class="sd">            If `featurename` is not `None`, gets list of all values</span>
<span class="sd">            to return for this feature and targets from `feature_parse_specs`.</span>
<span class="sd">            If `featurename` is `None`, gets list of all values for all</span>
<span class="sd">            features in target, prefixing with the feature name.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">featurename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">returnlist</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;query_name&#39;</span><span class="p">,</span> <span class="s1">&#39;query_clip5&#39;</span><span class="p">,</span> <span class="s1">&#39;query_clip3&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">featurename</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_to_parse</span><span class="p">(</span><span class="n">targetname</span><span class="p">,</span> <span class="s1">&#39;name&#39;</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_returnvals</span><span class="p">(</span><span class="n">targetname</span><span class="p">,</span> <span class="n">featurename</span><span class="p">):</span>
                    <span class="n">returnlist</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;</span><span class="si">{featurename}</span><span class="s2">_</span><span class="si">{val}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">returnlist</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="p">[</span><span class="n">targetname</span><span class="p">][</span><span class="n">featurename</span><span class="p">][</span><span class="s1">&#39;return&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_parse_single_Alignment</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">targetname</span><span class="p">,</span> <span class="n">filtered_cs</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse a single alignment.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        a : :class:`alignparse.cs_tag.Alignment`</span>
<span class="sd">        targetname : str</span>
<span class="sd">        filtered_cs : bool</span>

<span class="sd">        Returns</span>
<span class="sd">        --------</span>
<span class="sd">        2-tuple</span>
<span class="sd">            Tuple `(is_filtered, parse_tup)` where `is_filtered` is bool</span>
<span class="sd">            indicating if alignment fails `feature_parse_specs` filters.</span>
<span class="sd">            If it fails and `filtered_cs` is `False`, `parse_tup` is 2-tuple</span>
<span class="sd">            `(query_name, filter_reason)`. If it fails and `filtered_cs` is</span>
<span class="sd">            `True`, `parse_tup` is tuple `(query_name, filter_reason,</span>
<span class="sd">            filtered_cs)`. If it passes, `parse_tup` is list giving values</span>
<span class="sd">            specified by :meth:`_parse_returnvals` for `targetname`.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">query_name</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">query_name</span>
        <span class="n">parse_tup</span> <span class="o">=</span> <span class="p">[</span><span class="n">query_name</span><span class="p">]</span>

        <span class="c1"># get and filter on query clipping</span>
        <span class="k">for</span> <span class="n">clip</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;query_clip5&#39;</span><span class="p">,</span> <span class="s1">&#39;query_clip3&#39;</span><span class="p">]:</span>
            <span class="n">clipval</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>
            <span class="n">clipmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_feature_parse_specs</span><span class="p">[</span><span class="n">targetname</span><span class="p">][</span><span class="n">clip</span><span class="p">]</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">clipmax</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">clipval</span> <span class="o">&lt;=</span> <span class="n">clipmax</span><span class="p">:</span>
                <span class="n">parse_tup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clipval</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="n">query_name</span><span class="p">,</span> <span class="n">clip</span><span class="p">)</span>

        <span class="c1"># get and filter on features</span>
        <span class="n">target_parse_filters</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_filters</span><span class="p">[</span><span class="n">targetname</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_to_parse</span><span class="p">(</span><span class="n">targetname</span><span class="p">):</span>
            <span class="n">feat_info</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">extract_cs</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">feat_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># feature is fully clipped, determine which end</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">target_clip5</span> <span class="o">&gt;=</span> <span class="n">feature</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
                    <span class="n">clip5</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">length</span>
                    <span class="n">clip3</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">cs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">target_lastpos</span> <span class="o">&lt;=</span> <span class="n">feature</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                    <span class="n">clip5</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="n">clip3</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">length</span>
                    <span class="n">cs</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                            <span class="n">f</span><span class="s2">&quot;Should not get here:</span><span class="se">\n</span><span class="s2">target = </span><span class="si">{targetname}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="n">f</span><span class="s2">&quot;feature = </span><span class="si">{feature}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="n">f</span><span class="s2">&quot;target_clip5 = </span><span class="si">{a.target_clip5}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="n">f</span><span class="s2">&quot;lastpos = </span><span class="si">{a.target_lastpos}</span><span class="se">\n</span><span class="s2">&quot;</span>
                            <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">cs</span><span class="p">,</span> <span class="n">clip5</span><span class="p">,</span> <span class="n">clip3</span> <span class="o">=</span> <span class="n">feat_info</span>

            <span class="c1"># apply filters</span>
            <span class="n">featurename</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span>
            <span class="n">filter_vals</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;clip5&#39;</span><span class="p">:</span> <span class="n">clip5</span><span class="p">,</span>
                           <span class="s1">&#39;clip3&#39;</span><span class="p">:</span> <span class="n">clip3</span><span class="p">,</span>
                           <span class="s1">&#39;mutation_nt_count&#39;</span><span class="p">:</span> <span class="n">cs_to_nt_mutation_count</span><span class="p">(</span><span class="n">cs</span><span class="p">),</span>
                           <span class="s1">&#39;mutation_op_count&#39;</span><span class="p">:</span> <span class="n">cs_to_op_mutation_count</span><span class="p">(</span><span class="n">cs</span><span class="p">),</span>
                           <span class="p">}</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">valmax</span> <span class="ow">in</span> <span class="n">target_parse_filters</span><span class="p">[</span><span class="n">featurename</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">filter_vals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">valmax</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">filtered_cs</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="n">query_name</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{featurename}</span><span class="s2"> </span><span class="si">{key}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">cs</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="p">(</span><span class="n">query_name</span><span class="p">,</span> <span class="n">f</span><span class="s2">&quot;</span><span class="si">{featurename}</span><span class="s2"> </span><span class="si">{key}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># get return values</span>
            <span class="k">for</span> <span class="n">return_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_returnvals</span><span class="p">(</span><span class="n">targetname</span><span class="p">,</span> <span class="n">featurename</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">return_name</span> <span class="o">==</span> <span class="s1">&#39;clip5&#39;</span><span class="p">:</span>
                    <span class="n">parse_tup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clip5</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">return_name</span> <span class="o">==</span> <span class="s1">&#39;clip3&#39;</span><span class="p">:</span>
                    <span class="n">parse_tup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clip3</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">return_name</span> <span class="o">==</span> <span class="s1">&#39;mutations&#39;</span><span class="p">:</span>
                    <span class="n">parse_tup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs_to_mutation_str</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">clip5</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">return_name</span> <span class="o">==</span> <span class="s1">&#39;cs&#39;</span><span class="p">:</span>
                    <span class="n">parse_tup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">return_name</span> <span class="o">==</span> <span class="s1">&#39;sequence&#39;</span><span class="p">:</span>
                    <span class="n">clippedseq</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">seq</span><span class="p">[</span><span class="n">clip5</span><span class="p">:</span> <span class="n">feature</span><span class="o">.</span><span class="n">length</span> <span class="o">-</span> <span class="n">clip3</span><span class="p">]</span>
                    <span class="n">parse_tup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cs_to_sequence</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">clippedseq</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">return_name</span> <span class="o">==</span> <span class="s1">&#39;accuracy&#39;</span><span class="p">:</span>
                    <span class="n">parse_tup</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">get_accuracy</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">start</span><span class="p">,</span>
                                                    <span class="n">feature</span><span class="o">.</span><span class="n">end</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">allowednames</span> <span class="o">=</span> <span class="p">[</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_suffixes</span><span class="p">]</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;invalid `return_name` </span><span class="si">{return_name}</span><span class="s2">, &quot;</span>
                                     <span class="n">f</span><span class="s2">&quot;should be one of </span><span class="si">{allowednames}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># if here, alignment not filtered: return it</span>
        <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">parse_tup</span>

    <span class="k">def</span> <span class="nf">_parse_alignment_cs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samfile</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">multi_align</span><span class="o">=</span><span class="s1">&#39;primary&#39;</span><span class="p">,</span>
                            <span class="n">skip_sups</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse alignment feature ``cs`` strings for aligned queries.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        This method returns the same information that can be better</span>
<span class="sd">        obtained via :meth:`Targets.parse_alignments` by setting</span>
<span class="sd">        to return &#39;cs&#39;, &#39;clip5&#39;, &#39;clip3&#39; for every feature. It is</span>
<span class="sd">        currently retained only for debugging / testing purposes,</span>
<span class="sd">        and may eventually be removed.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        See parameter definitions in :meth:`Targets.parse_alignment`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Keyed be each target name. If there are no alignments for</span>
<span class="sd">            that target, value is `None`. Otherwise, value is a pandas</span>
<span class="sd">            DataFrame with a row for each feature in each query. The</span>
<span class="sd">            columns in this data frame are:</span>

<span class="sd">                - &#39;query_name&#39; : name of query in `samfile`</span>

<span class="sd">                - &#39;query_clip5&#39; : length at 5&#39; end of query not in alignment</span>

<span class="sd">                - &#39;query_clip3&#39; : length at 3&#39; end of query not in alignment</span>

<span class="sd">                - for each feature listed for that target in</span>
<span class="sd">                  :meth:`Target.feature_parse_specs`, columns with name of the</span>
<span class="sd">                  feature and the following suffixes:</span>

<span class="sd">                    - &#39;_cs&#39; : the ``cs`` string for the aligned portion</span>
<span class="sd">                      of the target.</span>

<span class="sd">                    - &#39;_clip5&#39; : number of nucleotides clipped from 5&#39; end</span>
<span class="sd">                      of feature in alignment.</span>

<span class="sd">                    - &#39;_clip3&#39; : number of nucleotides clipped from 3&#39; end</span>
<span class="sd">                      of feature in alignment.</span>

<span class="sd">                  If the feature is not aligned at all, then the &#39;_cs&#39; suffix</span>
<span class="sd">                  column is an empty str, and either &#39;_clip5&#39; or &#39;_clip3&#39; will</span>
<span class="sd">                  be the whole length of feature depending on if feature is</span>
<span class="sd">                  upstream or downstream of aligned region.</span>

<span class="sd">            The returned dict also has a key &#39;unmapped&#39; which gives</span>
<span class="sd">            the number of unmapped reads.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">suffixes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_return_suffixes</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
        <span class="n">d</span> <span class="o">=</span> <span class="p">{</span><span class="n">target</span><span class="p">:</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">}</span>
        <span class="k">if</span> <span class="s1">&#39;unmapped&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">target_names</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cannot have a target named &quot;unmapped&quot;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">d</span><span class="p">[</span><span class="s1">&#39;unmapped&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">multi_align</span> <span class="o">==</span> <span class="s1">&#39;primary&#39;</span><span class="p">:</span>
            <span class="n">primary_only</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;invalid `multi_align` </span><span class="si">{multi_align}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">aligned_seg</span> <span class="ow">in</span> <span class="n">pysam</span><span class="o">.</span><span class="n">AlignmentFile</span><span class="p">(</span><span class="n">samfile</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">aligned_seg</span><span class="o">.</span><span class="n">is_unmapped</span><span class="p">:</span>
                <span class="n">d</span><span class="p">[</span><span class="s1">&#39;unmapped&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">primary_only</span> <span class="ow">and</span> <span class="n">aligned_seg</span><span class="o">.</span><span class="n">is_secondary</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="k">if</span> <span class="n">skip_sups</span> <span class="ow">and</span> <span class="n">aligned_seg</span><span class="o">.</span><span class="n">is_supplementary</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">Alignment</span><span class="p">(</span><span class="n">aligned_seg</span><span class="p">,</span> <span class="n">introns_to_deletions</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                              <span class="n">target_seqs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">target_seqs</span><span class="p">)</span>
                <span class="n">tname</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">target_name</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">col</span><span class="p">:</span> <span class="p">[]</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reserved_cols</span><span class="p">}</span>
                    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_to_parse</span><span class="p">(</span><span class="n">tname</span><span class="p">):</span>
                        <span class="n">fname</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span>
                        <span class="k">for</span> <span class="n">suffix</span> <span class="ow">in</span> <span class="n">suffixes</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span> <span class="o">+</span> <span class="n">suffix</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="s1">&#39;query_name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">query_name</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="s1">&#39;query_clip5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">query_clip5</span><span class="p">)</span>
                <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="s1">&#39;query_clip3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">query_clip3</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">features_to_parse</span><span class="p">(</span><span class="n">tname</span><span class="p">):</span>
                    <span class="n">feat_info</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">extract_cs</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">start</span><span class="p">,</span> <span class="n">feature</span><span class="o">.</span><span class="n">end</span><span class="p">)</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">feature</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">feat_info</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_cs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;&#39;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">target_clip5</span> <span class="o">&gt;=</span> <span class="n">feature</span><span class="o">.</span><span class="n">end</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_clip5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_clip3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">target_lastpos</span> <span class="o">&lt;=</span> <span class="n">feature</span><span class="o">.</span><span class="n">start</span><span class="p">:</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_clip5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_clip3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                                <span class="n">f</span><span class="s2">&quot;Should never get here for target </span><span class="si">{tname}</span><span class="s2">:</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="n">f</span><span class="s2">&quot;feature = </span><span class="si">{feature}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="n">f</span><span class="s2">&quot;target_clip5 = </span><span class="si">{a.target_clip5}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="n">f</span><span class="s2">&quot;lastpos = </span><span class="si">{a.target_lastpos}</span><span class="se">\n</span><span class="s2">&quot;</span>
                                <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_cs&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_clip5&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat_info</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">tname</span><span class="p">][</span><span class="n">fname</span> <span class="o">+</span> <span class="s1">&#39;_clip3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feat_info</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">target</span> <span class="o">!=</span> <span class="s1">&#39;unmapped&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">d</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">d</span><span class="p">[</span><span class="n">target</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">target</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">d</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>
    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/BloomLogo.jpg" alt="Logo"/>
    
    <h1 class="logo logo-name">alignparse</h1>
    
  </a>
</p>



<p class="blurb">Align sequences and then parse features.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jbloomlab&repo=alignparse&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/jbloomlab/alignparse">
    <img
        alt="https://secure.travis-ci.org/jbloomlab/alignparse.svg?branch=master"
        src="https://secure.travis-ci.org/jbloomlab/alignparse.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">alignparse documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alignparse.html">alignparse package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_index.html">Package index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgments.html">Acknowledgements</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019--2019.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 2.2.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/jbloomlab/alignparse" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>