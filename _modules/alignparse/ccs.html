
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>alignparse.ccs &#8212; alignparse 0.5.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for alignparse.ccs</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">===</span>
<span class="sd">ccs</span>
<span class="sd">===</span>

<span class="sd">Tools for inspecting output of the PacBio ``ccs`` program:</span>
<span class="sd">https://github.com/PacificBiosciences/unanimity/blob/develop/doc/PBCCS.md</span>

<span class="sd">&quot;&quot;&quot;</span>


<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">tempfile</span>  <span class="c1"># noqa: F401</span>
<span class="kn">import</span> <span class="nn">textwrap</span>  <span class="c1"># noqa: F401</span>

<span class="kn">import</span> <span class="nn">numpy</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">pathos</span>

<span class="kn">import</span> <span class="nn">plotnine</span> <span class="k">as</span> <span class="nn">p9</span>

<span class="kn">import</span> <span class="nn">pysam</span>

<span class="kn">import</span> <span class="nn">alignparse.utils</span>
<span class="kn">from</span> <span class="nn">alignparse.constants</span> <span class="kn">import</span> <span class="n">CBPALETTE</span>


<div class="viewcode-block" id="Summary"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.Summary">[docs]</a><span class="k">class</span> <span class="nc">Summary</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Summary of a single ``ccs`` run.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the ``ccs`` run.</span>
<span class="sd">    fastqfile : str</span>
<span class="sd">        FASTQ file with circular consensus sequences, typically generated by</span>
<span class="sd">        PacBio ``ccs`` program. Can be gzipped. Number of passes is determined</span>
<span class="sd">        from the ``np`` tag in the FASTQ comments if present.</span>
<span class="sd">    reportfile : str or None</span>
<span class="sd">        Report file generated by ``ccs`` using ``--reportFile`` flag, or</span>
<span class="sd">        None if no such report available.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of ``ccs`` run.</span>
<span class="sd">    fastqfile : str</span>
<span class="sd">        FASTQ file with the circular consensus sequences.</span>
<span class="sd">    reportfile : str or None</span>
<span class="sd">        ``ccs`` report file. Currently handles reports in formats generated</span>
<span class="sd">        by ``ccs`` versions 3.* and 4.0.</span>
<span class="sd">    zmw_stats : pandas.DataFrame or None</span>
<span class="sd">        Stats on ZMW extracted from `reportfile`.</span>
<span class="sd">    passes : numpy.array or None</span>
<span class="sd">        Lists number of passes for all circular consensus sequences, or</span>
<span class="sd">        `None` if this information is not available in a ``np`` tag</span>
<span class="sd">        in `fastqfile`.</span>
<span class="sd">    accuracy : numpy.array</span>
<span class="sd">        Lists accuracies for all circular consensus sequences. This is the</span>
<span class="sd">        average accuracy across sites computed from Q-values in `fastqfile`.</span>
<span class="sd">    length : numpy.array</span>
<span class="sd">        Lists lengths for all circular consensus sequences.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">fastqfile</span><span class="p">,</span> <span class="n">reportfile</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See main class docstring.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastqfile</span> <span class="o">=</span> <span class="n">fastqfile</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fastqfile</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot find `fastqfile` </span><span class="si">{</span><span class="n">fastqfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">ccs_stats</span> <span class="o">=</span> <span class="n">get_ccs_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fastqfile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">passes</span> <span class="o">=</span> <span class="n">ccs_stats</span><span class="o">.</span><span class="n">passes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span> <span class="o">=</span> <span class="n">ccs_stats</span><span class="o">.</span><span class="n">accuracy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">ccs_stats</span><span class="o">.</span><span class="n">length</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">accuracy</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span>
        <span class="k">assert</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">passes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">reportfile</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reportfile</span> <span class="o">=</span> <span class="n">reportfile</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">reportfile</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cannot find `reportfile` </span><span class="si">{</span><span class="n">reportfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zmw_stats</span> <span class="o">=</span> <span class="n">report_to_stats</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">reportfile</span><span class="p">)</span>
            <span class="n">zmw_stats_nccs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmw_stats</span><span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">zmw_stats</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Success&quot;</span><span class="p">)</span>
            <span class="p">][</span><span class="s2">&quot;number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">length</span><span class="p">)</span> <span class="o">!=</span> <span class="n">zmw_stats_nccs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;`fastqfile`, `reportfile` differ on number &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;CCSs.</span><span class="se">\n</span><span class="si">{</span><span class="n">fastqfile</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">passes</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">reportfile</span><span class="si">}</span><span class="s2"> has </span><span class="si">{</span><span class="n">zmw_stats_nccs</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">zmw_stats</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reportfile</span> <span class="o">=</span> <span class="kc">None</span></div>


<div class="viewcode-block" id="Summaries"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.Summaries">[docs]</a><span class="k">class</span> <span class="nc">Summaries</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Summaries of ``ccs`` runs.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        Data frame giving information on runs of ``ccs`` being summarized.</span>
<span class="sd">    name_col : str</span>
<span class="sd">        Column in `df` with name of ``ccs`` run.</span>
<span class="sd">    fastq_col : str</span>
<span class="sd">        Column in `df` with FASTQ file for run, appropriate for passing</span>
<span class="sd">        to :class:`Summary` as `fastqfile`.</span>
<span class="sd">    report_col : str or None</span>
<span class="sd">        Column in `df` with report for run, appropriate for passing to</span>
<span class="sd">        :class:`Summary` as `reportfile`. Set to `None` if no reports.</span>
<span class="sd">        If there are no reports, then ZMW stats are not available.</span>
<span class="sd">    ncpus : int</span>
<span class="sd">        Number of CPUs to use; -1 means all available. Useful as processing</span>
<span class="sd">        all the FASTQ files to compute read accuracies can take a while.</span>

<span class="sd">    Attributes</span>
<span class="sd">    ----------</span>
<span class="sd">    summaries : list</span>
<span class="sd">        List of :class:`Summary` objects for each run.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">name_col</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">fastq_col</span><span class="o">=</span><span class="s2">&quot;fastq&quot;</span><span class="p">,</span> <span class="n">report_col</span><span class="o">=</span><span class="s2">&quot;report&quot;</span><span class="p">,</span> <span class="n">ncpus</span><span class="o">=-</span><span class="mi">1</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;See main class docstring.&quot;&quot;&quot;</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">name_col</span><span class="p">,</span> <span class="n">fastq_col</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">report_col</span><span class="p">:</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">report_col</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cols</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">cols</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;repeated column names in `df`&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;`df` lacks column </span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;the run names in </span><span class="si">{</span><span class="n">name_col</span><span class="si">}</span><span class="s2"> are not unique&quot;</span><span class="p">)</span>

        <span class="c1"># get Summary for each run in a multiprocessing pool</span>
        <span class="k">if</span> <span class="n">ncpus</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="n">pathos</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">pathos</span><span class="o">.</span><span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">(),</span> <span class="n">ncpus</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ncpus</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;`ncpus` must be &gt;= 1&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">ncpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pool</span> <span class="o">=</span> <span class="n">pathos</span><span class="o">.</span><span class="n">pools</span><span class="o">.</span><span class="n">ProcessPool</span><span class="p">(</span><span class="n">ncpus</span><span class="p">)</span>
            <span class="n">map_func</span> <span class="o">=</span> <span class="n">pool</span><span class="o">.</span><span class="n">map</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">def</span> <span class="nf">map_func</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">[</span><span class="n">f</span><span class="p">(</span><span class="o">*</span><span class="n">argtup</span><span class="p">)</span> <span class="k">for</span> <span class="n">argtup</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">summaries</span> <span class="o">=</span> <span class="n">map_func</span><span class="p">(</span>
            <span class="n">Summary</span><span class="p">,</span>
            <span class="n">df</span><span class="p">[</span><span class="n">name_col</span><span class="p">],</span>
            <span class="n">df</span><span class="p">[</span><span class="n">fastq_col</span><span class="p">],</span>
            <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">report_col</span><span class="p">]</span> <span class="k">if</span> <span class="n">report_col</span> <span class="k">else</span> <span class="n">itertools</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="kc">None</span><span class="p">)),</span>
        <span class="p">)</span>
        <span class="c1"># close, clear pool: https://github.com/uqfoundation/pathos/issues/111</span>
        <span class="k">if</span> <span class="n">ncpus</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>
            <span class="n">pool</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

<div class="viewcode-block" id="Summaries.plot_ccs_stats"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.Summaries.plot_ccs_stats">[docs]</a>    <span class="k">def</span> <span class="nf">plot_ccs_stats</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variable</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">trim_frac</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span>
        <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">histogram_stat</span><span class="o">=</span><span class="s2">&quot;count&quot;</span><span class="p">,</span>
        <span class="n">maxcol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">panelsize</span><span class="o">=</span><span class="mf">1.75</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot histograms of CCS stats for all runs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        variable : {&#39;length&#39;, &#39;passes&#39;, &#39;accuracy&#39;}</span>
<span class="sd">            Variable for which we plot stats. You will get an error</span>
<span class="sd">            if :meth:`Summaries.has_stat` is not true for `variable`.</span>
<span class="sd">        trim_frac : float</span>
<span class="sd">            Trim this amount of the bottom and top fraction from the</span>
<span class="sd">            data before plotting. Useful if outliers greatly extend scale.</span>
<span class="sd">        bins : int</span>
<span class="sd">            Number of histogram binds</span>
<span class="sd">        histogram_stat : {&#39;count&#39;, &#39;density&#39;}</span>
<span class="sd">            Plot the count of CCSs or their density normalized for each run.</span>
<span class="sd">        maxcol : None or int</span>
<span class="sd">            Max number of columns in faceted plot.</span>
<span class="sd">        panelsize : float</span>
<span class="sd">            Size of each plot panel.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plotnine.ggplot.ggplot</span>
<span class="sd">            A panel of histograms.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ccs_stats</span><span class="p">(</span><span class="n">variable</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">lower</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">trim_frac</span><span class="p">),</span>
                <span class="n">upper</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">trim_frac</span><span class="p">),</span>
                <span class="n">trim</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;upper&quot;</span><span class="p">])</span> <span class="o">|</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;lower&quot;</span><span class="p">])</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;not trim&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">npanels</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">maxcol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="n">npanels</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ncol</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">maxcol</span><span class="p">,</span> <span class="n">npanels</span><span class="p">)</span>
        <span class="n">nrow</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">npanels</span> <span class="o">/</span> <span class="n">ncol</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;..</span><span class="si">{</span><span class="n">histogram_stat</span><span class="si">}</span><span class="s2">..&quot;</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_histogram</span><span class="p">(</span><span class="n">bins</span><span class="o">=</span><span class="n">bins</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">facet_wrap</span><span class="p">(</span><span class="s2">&quot;~ name&quot;</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="n">ncol</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span>
                <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="n">panelsize</span> <span class="o">*</span> <span class="n">ncol</span><span class="p">,</span> <span class="n">panelsize</span> <span class="o">*</span> <span class="n">nrow</span><span class="p">),</span>
                <span class="n">axis_text_x</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">vjust</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hjust</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">ylab</span><span class="p">(</span><span class="s2">&quot;number of CCSs&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="Summaries.ccs_stats"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.Summaries.ccs_stats">[docs]</a>    <span class="k">def</span> <span class="nf">ccs_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get CCS stats for all runs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        variable : {&#39;length&#39;, &#39;passes&#39;, &#39;accuracy&#39;}</span>
<span class="sd">            Variable for which we get stats. You will get an error</span>
<span class="sd">            if :meth:`Summaries.has_stat` is not true for `variable`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            Data frame with columns of &#39;name&#39; (holding run name) and the value</span>
<span class="sd">            of `variable` giving variable value for all CCSs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_stat</span><span class="p">(</span><span class="n">variable</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;no stats for `variable` </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">df_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaries</span><span class="p">:</span>
            <span class="n">df_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">summary</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">variable</span><span class="p">:</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">variable</span><span class="p">)}</span>
                <span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">df_list</span><span class="p">,</span> <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="Summaries.has_stat"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.Summaries.has_stat">[docs]</a>    <span class="k">def</span> <span class="nf">has_stat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">variable</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Do the summaries contain a statistic?</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        variable : {&#39;length&#39;, &#39;passes&#39;, &#39;accuracy&#39;}</span>
<span class="sd">            Variable for which we want statistics.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            `True` if all runs have statistics for `variable`,</span>
<span class="sd">            `False` otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">valid_variables</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;length&quot;</span><span class="p">,</span> <span class="s2">&quot;passes&quot;</span><span class="p">,</span> <span class="s2">&quot;accuracy&quot;</span><span class="p">}</span>
        <span class="k">if</span> <span class="n">variable</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_variables</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Invalid `variable` </span><span class="si">{</span><span class="n">variable</span><span class="si">}</span><span class="s2">. Must be one &quot;</span> <span class="sa">f</span><span class="s2">&quot;of: </span><span class="si">{</span><span class="n">valid_variables</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">summary</span><span class="p">,</span> <span class="n">variable</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaries</span><span class="p">)</span></div>

<div class="viewcode-block" id="Summaries.plot_zmw_stats"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.Summaries.plot_zmw_stats">[docs]</a>    <span class="k">def</span> <span class="nf">plot_zmw_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Plot of ZMW stats for all runs.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Raises an error if :meth:`Summaries.has_zmw_stats` is not `True`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ``**kwargs`` : dict</span>
<span class="sd">            Keyword arguments passed to :meth:`Summaries.zmw_stats`.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        plotnine.ggplot.ggplot</span>
<span class="sd">            Stacked bar graph of ZMW stats for each run.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">zmw_stats</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">p</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">p9</span><span class="o">.</span><span class="n">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">p9</span><span class="o">.</span><span class="n">aes</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="s2">&quot;status&quot;</span><span class="p">))</span>
            <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">geom_col</span><span class="p">(</span><span class="n">position</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">position_stack</span><span class="p">(</span><span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">theme</span><span class="p">(</span>
                <span class="n">axis_text_x</span><span class="o">=</span><span class="n">p9</span><span class="o">.</span><span class="n">element_text</span><span class="p">(</span><span class="n">angle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">vjust</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">hjust</span><span class="o">=</span><span class="mf">0.5</span><span class="p">),</span>
                <span class="n">figure_size</span><span class="o">=</span><span class="p">(</span><span class="mf">0.4</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()),</span> <span class="mf">2.5</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">ylab</span><span class="p">(</span><span class="s2">&quot;number of ZMWs&quot;</span><span class="p">)</span>
            <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">xlab</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">CBPALETTE</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">p</span> <span class="o">+</span> <span class="n">p9</span><span class="o">.</span><span class="n">scale_fill_manual</span><span class="p">(</span><span class="n">CBPALETTE</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">return</span> <span class="n">p</span></div>

<div class="viewcode-block" id="Summaries.zmw_stats"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.Summaries.zmw_stats">[docs]</a>    <span class="k">def</span> <span class="nf">zmw_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">minfailfrac</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">groupsuccess</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get ZMW stats for all runs.</span>

<span class="sd">        Note</span>
<span class="sd">        ----</span>
<span class="sd">        Raises an error if :meth:`Summaries.has_zmw_stats` is not `True`.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        minfailfrac : float</span>
<span class="sd">            Group failure categories with &lt;= this fraction ZMWs for all runs.</span>
<span class="sd">        groupsuccess : bool</span>
<span class="sd">            Group all success categories into &#39;Success -- CCS generated&#39;.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        pandas.DataFrame</span>
<span class="sd">            Data frame with stats on ZMW status for all runs.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_zmw_stats</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;ZMW stats not available&quot;</span><span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span><span class="n">summary</span><span class="o">.</span><span class="n">zmw_stats</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">summary</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaries</span><span class="p">],</span>
            <span class="n">sort</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)[[</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;fraction&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">max_fraction</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)[</span><span class="s2">&quot;fraction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">max</span><span class="p">)),</span>
            <span class="n">failed</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="s2">&quot;Failed&quot;</span><span class="p">),</span>
            <span class="n">other</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">((</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;max_fraction&quot;</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">minfailfrac</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;failed&quot;</span><span class="p">]),</span>
        <span class="p">)</span>

        <span class="n">other_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;other&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">aggregate</span><span class="p">({</span><span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">,</span> <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">})</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;Failed -- Other reason&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">max_fraction</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;status&quot;</span><span class="p">)[</span><span class="s2">&quot;fraction&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="nb">max</span><span class="p">))</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;not other&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;other&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">other_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">groupsuccess</span><span class="p">:</span>
            <span class="n">success_df</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">df</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Success&quot;</span><span class="p">)]</span>
                <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
                    <span class="p">{</span><span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">,</span> <span class="s2">&quot;fraction&quot;</span><span class="p">:</span> <span class="nb">sum</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">:</span> <span class="nb">any</span><span class="p">,</span> <span class="s2">&quot;max_fraction&quot;</span><span class="p">:</span> <span class="nb">max</span><span class="p">}</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">status</span><span class="o">=</span><span class="s2">&quot;Success -- CCS generated&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s2">&quot;^Success&quot;</span><span class="p">)]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">success_df</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">)</span>

        <span class="c1"># order columns</span>
        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">summary</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaries</span><span class="p">]</span>
        <span class="n">statuses</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;failed&quot;</span><span class="p">,</span> <span class="s2">&quot;max_fraction&quot;</span><span class="p">],</span> <span class="n">ascending</span><span class="o">=</span><span class="p">[</span><span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">])[</span>
            <span class="s2">&quot;status&quot;</span>
        <span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
        <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
                <span class="n">name</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">],</span> <span class="n">names</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                <span class="n">status</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">Categorical</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">],</span> <span class="n">statuses</span><span class="p">,</span> <span class="n">ordered</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;status&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;max_fraction&quot;</span><span class="p">,</span> <span class="s2">&quot;failed&quot;</span><span class="p">])</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">df</span></div>

<div class="viewcode-block" id="Summaries.has_zmw_stats"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.Summaries.has_zmw_stats">[docs]</a>    <span class="k">def</span> <span class="nf">has_zmw_stats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Are ZMW stats available?</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            `True` if all runs have ZMW stats, `False` otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">all</span><span class="p">(</span><span class="n">summary</span><span class="o">.</span><span class="n">zmw_stats</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">summary</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">summaries</span><span class="p">)</span></div></div>


<div class="viewcode-block" id="report_to_stats"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.report_to_stats">[docs]</a><span class="k">def</span> <span class="nf">report_to_stats</span><span class="p">(</span><span class="n">reportfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parse ZMW statistics from report file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    reportfile : str</span>
<span class="sd">        Report file generated by ``ccs`` using ``--reportFile`` flag</span>
<span class="sd">        using ``ccs`` version 3.* and 4.0, or the ``--report-file``</span>
<span class="sd">        flag using ``ccs`` version 5.0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        A data frame with the statistics.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    An example of the ``ccs`` version 5.0.0 output:</span>

<span class="sd">    &gt;&gt;&gt; pd.set_option(&#39;display.max_columns&#39;, 10)  # show many columns</span>
<span class="sd">    &gt;&gt;&gt; reportfile = tempfile.NamedTemporaryFile(mode=&#39;w&#39;)</span>
<span class="sd">    &gt;&gt;&gt; _ = reportfile.write(textwrap.dedent(&#39;&#39;&#39;</span>
<span class="sd">    ...     ZMWs input               : 535101</span>
<span class="sd">    ...</span>
<span class="sd">    ...     ZMWs pass filters        : 325574 (60.84%)</span>
<span class="sd">    ...     ZMWs fail filters        : 209527 (39.16%)</span>
<span class="sd">    ...     ZMWs shortcut filters    : 0 (0.00%)</span>
<span class="sd">    ...</span>
<span class="sd">    ...     ZMWs with tandem repeats : 98 (0.02%)</span>
<span class="sd">    ...</span>
<span class="sd">    ...     Exclusive counts for ZMWs failing filters:</span>
<span class="sd">    ...     Below SNR threshold      : 0 (0.00%)</span>
<span class="sd">    ...     Median length filter     : 0 (0.00%)</span>
<span class="sd">    ...     Lacking full passes      : 94869 (45.28%)</span>
<span class="sd">    ...     Heteroduplex insertions  : 4373 (2.09%)</span>
<span class="sd">    ...     Coverage drops           : 526 (0.25%)</span>
<span class="sd">    ...     Insufficient draft cov   : 2783 (1.33%)</span>
<span class="sd">    ...     Draft too different      : 1436 (0.69%)</span>
<span class="sd">    ...     Draft generation error   : 5426 (2.59%)</span>
<span class="sd">    ...     Draft above --max-length : 469 (0.22%)</span>
<span class="sd">    ...     Draft below --min-length : 152 (0.07%)</span>
<span class="sd">    ...     Reads failed polishing   : 0 (0.00%)</span>
<span class="sd">    ...     Empty coverage windows   : 136 (0.06%)</span>
<span class="sd">    ...     CCS did not converge     : 44 (0.02%)</span>
<span class="sd">    ...     CCS below minimum RQ     : 99782 (47.62%)</span>
<span class="sd">    ...     Unknown error            : 0 (0.00%)</span>
<span class="sd">    ...     &#39;&#39;&#39;).lstrip())</span>
<span class="sd">    &gt;&gt;&gt; reportfile.flush()</span>
<span class="sd">    &gt;&gt;&gt; report_to_stats(reportfile.name)</span>
<span class="sd">                                    status  number  fraction</span>
<span class="sd">    0             Success -- CCS generated  325574  0.607902</span>
<span class="sd">    1        Failed -- Below SNR threshold       0  0.000000</span>
<span class="sd">    2       Failed -- Median length filter       0  0.000000</span>
<span class="sd">    3        Failed -- Lacking full passes   94869  0.177137</span>
<span class="sd">    4    Failed -- Heteroduplex insertions    4373  0.008165</span>
<span class="sd">    5             Failed -- Coverage drops     526  0.000982</span>
<span class="sd">    6     Failed -- Insufficient draft cov    2783  0.005196</span>
<span class="sd">    7        Failed -- Draft too different    1436  0.002681</span>
<span class="sd">    8     Failed -- Draft generation error    5426  0.010131</span>
<span class="sd">    9   Failed -- Draft above --max-length     469  0.000876</span>
<span class="sd">    10  Failed -- Draft below --min-length     152  0.000284</span>
<span class="sd">    11    Failed -- Reads failed polishing       0  0.000000</span>
<span class="sd">    12    Failed -- Empty coverage windows     136  0.000254</span>
<span class="sd">    13      Failed -- CCS did not converge      44  0.000082</span>
<span class="sd">    14      Failed -- CCS below minimum RQ   99782  0.186310</span>
<span class="sd">    15             Failed -- Unknown error       0  0.000000</span>
<span class="sd">    16           Failed -- shortcut filter       0  0.000000</span>
<span class="sd">    &gt;&gt;&gt; reportfile.close()</span>

<span class="sd">    An example of the ``ccs`` version 4.0.0 output:</span>

<span class="sd">    &gt;&gt;&gt; pd.set_option(&#39;display.max_columns&#39;, 10)  # show many columns</span>
<span class="sd">    &gt;&gt;&gt; reportfile = tempfile.NamedTemporaryFile(mode=&#39;w&#39;)</span>
<span class="sd">    &gt;&gt;&gt; _ = reportfile.write(textwrap.dedent(&#39;&#39;&#39;</span>
<span class="sd">    ...     ZMWs input          (A)  : 686919</span>
<span class="sd">    ...     ZMWs generating CCS (B)  : 182500 (26.57%)</span>
<span class="sd">    ...     ZMWs filtered       (C)  : 504419 (73.43%)</span>
<span class="sd">    ...</span>
<span class="sd">    ...     Exclusive ZMW counts for (C):</span>
<span class="sd">    ...     No usable subreads       : 0 (0.00%)</span>
<span class="sd">    ...     Below SNR threshold      : 0 (0.00%)</span>
<span class="sd">    ...     Lacking full passes      : 344375 (68.27%)</span>
<span class="sd">    ...     Heteroduplexes           : 1056 (0.21%)</span>
<span class="sd">    ...     Min coverage violation   : 2035 (0.40%)</span>
<span class="sd">    ...     Draft generation error   : 7636 (1.51%)</span>
<span class="sd">    ...     Draft above --max-length : 49 (0.01%)</span>
<span class="sd">    ...     Draft below --min-length : 2 (0.00%)</span>
<span class="sd">    ...     Lacking usable subreads  : 0 (0.00%)</span>
<span class="sd">    ...     CCS did not converge     : 0 (0.00%)</span>
<span class="sd">    ...     CCS below minimum RQ     : 149315 (29.60%)</span>
<span class="sd">    ...     Unknown error            : 0 (0.00%)</span>
<span class="sd">    ...     &#39;&#39;&#39;).lstrip())</span>
<span class="sd">    &gt;&gt;&gt; reportfile.flush()</span>
<span class="sd">    &gt;&gt;&gt; report_to_stats(reportfile.name)</span>
<span class="sd">                                    status  number  fraction</span>
<span class="sd">    0             Success -- CCS generated  182500  0.265660</span>
<span class="sd">    1         Failed -- No usable subreads       0  0.000000</span>
<span class="sd">    2        Failed -- Below SNR threshold       0  0.000000</span>
<span class="sd">    3        Failed -- Lacking full passes  344375  0.501297</span>
<span class="sd">    4             Failed -- Heteroduplexes    1056  0.001537</span>
<span class="sd">    5     Failed -- Min coverage violation    2035  0.002962</span>
<span class="sd">    6     Failed -- Draft generation error    7636  0.011116</span>
<span class="sd">    7   Failed -- Draft above --max-length      49  0.000071</span>
<span class="sd">    8   Failed -- Draft below --min-length       2  0.000003</span>
<span class="sd">    9    Failed -- Lacking usable subreads       0  0.000000</span>
<span class="sd">    10      Failed -- CCS did not converge       0  0.000000</span>
<span class="sd">    11      Failed -- CCS below minimum RQ  149315  0.217354</span>
<span class="sd">    12             Failed -- Unknown error       0  0.000000</span>
<span class="sd">    &gt;&gt;&gt; reportfile.close()</span>

<span class="sd">    An example of the ``ccs`` version 3.1.0 output:</span>

<span class="sd">    &gt;&gt;&gt; reportfile = tempfile.NamedTemporaryFile(mode=&#39;w&#39;)</span>
<span class="sd">    &gt;&gt;&gt; _ = reportfile.write(textwrap.dedent(&#39;&#39;&#39;</span>
<span class="sd">    ...     ZMW Yield</span>
<span class="sd">    ...     Success -- CCS generated,242220,45.57%</span>
<span class="sd">    ...     Failed -- Below SNR threshold,0,0.00%</span>
<span class="sd">    ...     Failed -- No usable subreads,4877,0.92%</span>
<span class="sd">    ...     Failed -- Insert size too long,35,0.00%</span>
<span class="sd">    ...     Failed -- Insert size too small,0,0.00%</span>
<span class="sd">    ...     Failed -- Not enough full passes,180620,33.98%</span>
<span class="sd">    ...     Failed -- Too many unusable subreads,1,0.00%</span>
<span class="sd">    ...     Failed -- CCS did not converge,23,0.00%</span>
<span class="sd">    ...     Failed -- CCS below minimum predicted accuracy,103801,19.53%</span>
<span class="sd">    ...     Failed -- Unknown error during processing,0,0.00%</span>
<span class="sd">    ...</span>
<span class="sd">    ...</span>
<span class="sd">    ...     Subread Yield</span>
<span class="sd">    ...     Success - Used for CCS,10972010,89.06%</span>
<span class="sd">    ...     Failed -- Below SNR threshold,0,0.00%</span>
<span class="sd">    ...     Failed -- Alpha/Beta mismatch,171,0.00%</span>
<span class="sd">    ...     Failed -- Below minimum quality,0,0.00%</span>
<span class="sd">    ...     Failed -- Filtered by size,144209,1.17%</span>
<span class="sd">    ...     Failed -- Identity too low,2745750,22.29%</span>
<span class="sd">    ...     Failed -- Z-Score too low,0,0.00%</span>
<span class="sd">    ...     Failed -- From ZMW with too few passes,274296,2.23%</span>
<span class="sd">    ...     Failed -- Other,928871,7.54%</span>
<span class="sd">    ...     &#39;&#39;&#39;).lstrip())</span>
<span class="sd">    &gt;&gt;&gt; reportfile.flush()</span>
<span class="sd">    &gt;&gt;&gt; report_to_stats(reportfile.name)</span>
<span class="sd">                                               status  number  fraction</span>
<span class="sd">    0                        Success -- CCS generated  242220    0.4557</span>
<span class="sd">    1                   Failed -- Below SNR threshold       0    0.0000</span>
<span class="sd">    2                    Failed -- No usable subreads    4877    0.0092</span>
<span class="sd">    3                  Failed -- Insert size too long      35    0.0000</span>
<span class="sd">    4                 Failed -- Insert size too small       0    0.0000</span>
<span class="sd">    5                Failed -- Not enough full passes  180620    0.3398</span>
<span class="sd">    6            Failed -- Too many unusable subreads       1    0.0000</span>
<span class="sd">    7                  Failed -- CCS did not converge      23    0.0000</span>
<span class="sd">    8  Failed -- CCS below minimum predicted accuracy  103801    0.1953</span>
<span class="sd">    9       Failed -- Unknown error during processing       0    0.0000</span>
<span class="sd">    &gt;&gt;&gt; reportfile.close()</span>

<span class="sd">    An example of the ``ccs`` version 3.4.1 output:</span>

<span class="sd">    &gt;&gt;&gt; reportfile = tempfile.NamedTemporaryFile(mode=&#39;w&#39;)</span>
<span class="sd">    &gt;&gt;&gt; _ = reportfile.write(textwrap.dedent(&#39;&#39;&#39;</span>
<span class="sd">    ...     ZMW Yield</span>
<span class="sd">    ...     Success (without retry) -- CCS generated,202033,29.44%</span>
<span class="sd">    ...     Success (with retry)    -- CCS generated,2,0.00%</span>
<span class="sd">    ...     Failed -- Below SNR threshold,0,0.00%</span>
<span class="sd">    ...     Failed -- No usable subreads,2093,0.31%</span>
<span class="sd">    ...     Failed -- Insert size too long,10,0.01%</span>
<span class="sd">    ...     Failed -- Insert size too small,79,0.01%</span>
<span class="sd">    ...     Failed -- Not enough full passes,343876,50.12%</span>
<span class="sd">    ...     Failed -- Too many unusable subreads,0,0.00%</span>
<span class="sd">    ...     Failed -- CCS did not converge,0,0.00%</span>
<span class="sd">    ...     Failed -- CCS below minimum predicted accuracy,138083,20.12%</span>
<span class="sd">    ...     Failed -- Unknown error during processing,0,0.00%</span>
<span class="sd">    ...</span>
<span class="sd">    ...</span>
<span class="sd">    ...     &#39;&#39;&#39;).lstrip())</span>
<span class="sd">    &gt;&gt;&gt; reportfile.flush()</span>
<span class="sd">    &gt;&gt;&gt; report_to_stats(reportfile.name)  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">                                               status  number fraction</span>
<span class="sd">    0        Success (without retry) -- CCS generated  202033   0.2944</span>
<span class="sd">    1        Success (with retry)    -- CCS generated       2   0.0000</span>
<span class="sd">    2                   Failed -- Below SNR threshold       0   0.0000</span>
<span class="sd">    3                    Failed -- No usable subreads    2093   0.0031</span>
<span class="sd">    4                  Failed -- Insert size too long      10   0.0001</span>
<span class="sd">    5                 Failed -- Insert size too small      79   0.0001</span>
<span class="sd">    6                Failed -- Not enough full passes  343876   0.5012</span>
<span class="sd">    7            Failed -- Too many unusable subreads       0   0.0000</span>
<span class="sd">    8                  Failed -- CCS did not converge       0   0.0000</span>
<span class="sd">    9  Failed -- CCS below minimum predicted accuracy  138083   0.2012</span>
<span class="sd">    10      Failed -- Unknown error during processing       0   0.0000</span>
<span class="sd">    &gt;&gt;&gt; reportfile.close()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_report_to_stats_v5</span><span class="p">,</span> <span class="n">_report_to_stats_v4</span><span class="p">,</span> <span class="n">_report_to_stats_v3</span><span class="p">]:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">reportfile</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">df</span>

    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cannot match report in </span><span class="si">{</span><span class="n">reportfile</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">_report_to_stats_v5</span><span class="p">(</span><span class="n">reportfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implement :func:`report_to_stats` for ``ccs`` 5.* output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame or None</span>
<span class="sd">        Returns `None` if cannot match `reportfile`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reportmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^ZMWs input\s+:\s+\d+[\s\n]+&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;ZMWs pass filters\s+:\s+(?P&lt;n_generated&gt;\d+) \S+\n&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;ZMWs fail filters\s+:\s+(?P&lt;n_fail&gt;\d+) \S+\n&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;ZMWs shortcut filters\s+:\s+(?P&lt;n_shortcut_filters&gt;\d+) \S+\n&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;ZMWs with tandem repeats\s+:\s+\d+ \S+\n&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;Exclusive counts for ZMWs failing filters:\n&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;(?P&lt;failed_text&gt;([\w \-]+\s+: \d+ \S+\n)+)$&quot;</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">reportfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">reportmatch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">failed_records</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="s2">&quot;Failed -- &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;failed_text&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span>
        <span class="p">]</span>
        <span class="n">failed_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;Failed -- shortcut filter&quot;</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;n_shortcut_filters&quot;</span><span class="p">)))</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Success -- CCS generated&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;n_generated&quot;</span><span class="p">))],</span>
                        <span class="p">}</span>
                    <span class="p">),</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">failed_records</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">]),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_report_to_stats_v4</span><span class="p">(</span><span class="n">reportfile</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implement :func:`report_to_stats` for ``ccs`` 4.* output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame or None</span>
<span class="sd">        Returns `None` if cannot match `reportfile`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reportmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="sa">r</span><span class="s2">&quot;^ZMWs input\s+\(A\)\s+:\s+\d+[\s\n]+&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;ZMWs generating CCS\s+\(B\)\s+:\s+(?P&lt;n_generated&gt;\d+) \S+\n&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;ZMWs filtered\s+\(C\)\s+:\s+\d+ \S+\n&quot;</span>
        <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;Exclusive ZMW counts for \(C\):\n&quot;</span>
        <span class="sa">r</span><span class="s2">&quot;(?P&lt;failed_text&gt;([\w \-]+: \d+ \S+\n)+)$&quot;</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">reportfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">reportmatch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">failed_records</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="s2">&quot;Failed -- &quot;</span> <span class="o">+</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span>
                <span class="nb">int</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">0</span><span class="p">]),</span>
            <span class="p">)</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;failed_text&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">line</span>
        <span class="p">]</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;status&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;Success -- CCS generated&quot;</span><span class="p">],</span>
                            <span class="s2">&quot;number&quot;</span><span class="p">:</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;n_generated&quot;</span><span class="p">))],</span>
                        <span class="p">}</span>
                    <span class="p">),</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">failed_records</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">]),</span>
                <span class="p">]</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">fraction</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;number&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">_report_to_stats_v3</span><span class="p">(</span><span class="n">reportfile</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">stat_type</span><span class="o">=</span><span class="s2">&quot;zmw&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Implement :func:`report_to_stats` for ``ccs`` 3.* output.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame or None</span>
<span class="sd">        Returns `None` if cannot match `reportfile`.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">reportmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
        <span class="s2">&quot;^ZMW Yield</span><span class="se">\n</span><span class="s2">(?P&lt;zmw&gt;(.+</span><span class="se">\n</span><span class="s2">)+)</span><span class="se">\n\n</span><span class="s2">&quot;</span> <span class="s2">&quot;(?:Subread Yield</span><span class="se">\n</span><span class="s2">(?P&lt;subread&gt;(.+</span><span class="se">\n</span><span class="s2">)+))?$&quot;</span>
    <span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">reportfile</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">report</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">reportmatch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span>
            <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="n">stat_type</span><span class="p">)),</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;percent&quot;</span><span class="p">]</span>
        <span class="p">)</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span>
            <span class="n">fraction</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">percent</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">slice</span><span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
        <span class="p">)[</span>
            <span class="p">[</span><span class="s2">&quot;status&quot;</span><span class="p">,</span> <span class="s2">&quot;number&quot;</span><span class="p">,</span> <span class="s2">&quot;fraction&quot;</span><span class="p">]</span>
        <span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<div class="viewcode-block" id="get_ccs_stats"><a class="viewcode-back" href="../../alignparse.ccs.html#alignparse.ccs.get_ccs_stats">[docs]</a><span class="k">def</span> <span class="nf">get_ccs_stats</span><span class="p">(</span><span class="n">fastqfile</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">pass_tag</span><span class="o">=</span><span class="s2">&quot;np&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get basic statistics about circular consensus sequences.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    fastqfile : str</span>
<span class="sd">        FASTQ file with circular consensus sequences, generated from BAM output</span>
<span class="sd">        of ``ccs``.</span>
<span class="sd">    pass_tag : str</span>
<span class="sd">        Tag in FASTQ file header giving number of passes (if present).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    collections.namedtuple</span>
<span class="sd">        The 3-tuple `(passes, accuracy, length)` contains numpy arrays</span>
<span class="sd">        giving number of passes, accuracies, and lengths for sequences in</span>
<span class="sd">        `fastqfile`. The accuracy (average across sequence) and length</span>
<span class="sd">        are computed from the quality scores and sequence in `fastqfile`;</span>
<span class="sd">        the number of passes must be provided as `pass_tag` and are returned</span>
<span class="sd">        as `None` if that tag is missing from any read in `fastqfile`.</span>

<span class="sd">    Example</span>
<span class="sd">    -------</span>
<span class="sd">    Test with ``np`` tag in format from ``ccs`` version 5.0.</span>

<span class="sd">    &gt;&gt;&gt; fastqfile = tempfile.NamedTemporaryFile(mode=&#39;w&#39;)</span>
<span class="sd">    &gt;&gt;&gt; _ = fastqfile.write(textwrap.dedent(&#39;&#39;&#39;</span>
<span class="sd">    ...   @m54228_190118_102822/4194373/ccs np=18</span>
<span class="sd">    ...   GGTACCACACTCTTTCCCTACACGACGCTCTGCCGATCTCGGCCATTACGTGTTTTATCTA</span>
<span class="sd">    ...   +</span>
<span class="sd">    ...   ~~~~{~~~~~~~c~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~i~~~~~~~(</span>
<span class="sd">    ...   @m54228_190118_102822/4194374/ccs np=51</span>
<span class="sd">    ...   GCACGGCGTCACACTTTGCTATGCCATAGCATGTTTATCCATAAGATTAGCGGATCCTACCT</span>
<span class="sd">    ...   +</span>
<span class="sd">    ...   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">    ...   &#39;&#39;&#39;).lstrip())</span>
<span class="sd">    &gt;&gt;&gt; fastqfile.flush()</span>
<span class="sd">    &gt;&gt;&gt; get_ccs_stats(fastqfile.name)  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    CCS_Stats(passes=array([18, 51]),</span>
<span class="sd">              accuracy=array([0.99672907, 1.        ]),</span>
<span class="sd">              length=array([61, 62]))</span>
<span class="sd">    &gt;&gt;&gt; fastqfile.close()</span>

<span class="sd">    Test with ``np`` tag in format from ``ccs`` version 4.0.</span>

<span class="sd">    &gt;&gt;&gt; fastqfile = tempfile.NamedTemporaryFile(mode=&#39;w&#39;)</span>
<span class="sd">    &gt;&gt;&gt; _ = fastqfile.write(textwrap.dedent(&#39;&#39;&#39;</span>
<span class="sd">    ...   @m54228_190118_102822/4194373/ccs np:i:18</span>
<span class="sd">    ...   GGTACCACACTCTTTCCCTACACGACGCTCTGCCGATCTCGGCCATTACGTGTTTTATCTA</span>
<span class="sd">    ...   +</span>
<span class="sd">    ...   ~~~~{~~~~~~~c~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~i~~~~~~~(</span>
<span class="sd">    ...   @m54228_190118_102822/4194374/ccs np:i:51</span>
<span class="sd">    ...   GCACGGCGTCACACTTTGCTATGCCATAGCATGTTTATCCATAAGATTAGCGGATCCTACCT</span>
<span class="sd">    ...   +</span>
<span class="sd">    ...   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">    ...   &#39;&#39;&#39;).lstrip())</span>
<span class="sd">    &gt;&gt;&gt; fastqfile.flush()</span>
<span class="sd">    &gt;&gt;&gt; get_ccs_stats(fastqfile.name)  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    CCS_Stats(passes=array([18, 51]),</span>
<span class="sd">              accuracy=array([0.99672907, 1.        ]),</span>
<span class="sd">              length=array([61, 62]))</span>
<span class="sd">    &gt;&gt;&gt; fastqfile.close()</span>

<span class="sd">    Similar test without ``np`` tag in FASTQ file:</span>

<span class="sd">    &gt;&gt;&gt; fastqfile = tempfile.NamedTemporaryFile(mode=&#39;w&#39;)</span>
<span class="sd">    &gt;&gt;&gt; _ = fastqfile.write(textwrap.dedent(&#39;&#39;&#39;</span>
<span class="sd">    ...   @m54228_190118_102822/4194373/ccs</span>
<span class="sd">    ...   GGTACCACACTCTTTCCCTACACGACGCTCTGCCGATCTCGGCCATTACGTGTTTTATCTA</span>
<span class="sd">    ...   +</span>
<span class="sd">    ...   ~~~~{~~~~~~~c~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~i~~~~~~~(</span>
<span class="sd">    ...   @m54228_190118_102822/4194374/ccs</span>
<span class="sd">    ...   GCACGGCGTCACACTTTGCTATGCCATAGCATGTTTATCCATAAGATTAGCGGATCCTACCT</span>
<span class="sd">    ...   +</span>
<span class="sd">    ...   ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
<span class="sd">    ...   &#39;&#39;&#39;).lstrip())</span>
<span class="sd">    &gt;&gt;&gt; fastqfile.flush()</span>
<span class="sd">    &gt;&gt;&gt; get_ccs_stats(fastqfile.name)  # doctest: +NORMALIZE_WHITESPACE</span>
<span class="sd">    CCS_Stats(passes=None,</span>
<span class="sd">              accuracy=array([0.99672907, 1.        ]),</span>
<span class="sd">              length=array([61, 62]))</span>
<span class="sd">    &gt;&gt;&gt; fastqfile.close()</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pass_tag</span><span class="p">:</span>
        <span class="n">passmatch</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span>
            <span class="sa">r</span><span class="s2">&quot;(?:^|\s)&quot;</span>  <span class="c1"># start of str or space</span>
            <span class="sa">rf</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">pass_tag</span><span class="si">}</span><span class="s2">(?::i:|=)(?P&lt;pass&gt;\d+)&quot;</span>
            <span class="sa">r</span><span class="s2">&quot;(?:\s|$)&quot;</span>  <span class="c1"># end of str or space</span>
        <span class="p">)</span>
        <span class="n">passes</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">passes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="n">length</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">accuracy</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">pysam</span><span class="o">.</span><span class="n">FastxFile</span><span class="p">(</span><span class="n">fastqfile</span><span class="p">):</span>
        <span class="n">length</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">sequence</span><span class="p">))</span>
        <span class="n">accuracy</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">alignparse</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">qvals_to_accuracy</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">get_quality_array</span><span class="p">()))</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">passes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rec</span><span class="o">.</span><span class="n">comment</span><span class="p">:</span>
                <span class="n">passes</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">passmatch</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">rec</span><span class="o">.</span><span class="n">comment</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">passes</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">passes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="s2">&quot;pass&quot;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">passes</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">passes</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">passes</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
    <span class="n">CCS_Stats</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">namedtuple</span><span class="p">(</span><span class="s2">&quot;CCS_Stats&quot;</span><span class="p">,</span> <span class="s2">&quot;passes accuracy length&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">CCS_Stats</span><span class="p">(</span>
        <span class="n">passes</span><span class="o">=</span><span class="n">passes</span><span class="p">,</span>
        <span class="n">accuracy</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">accuracy</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;float&quot;</span><span class="p">),</span>
        <span class="n">length</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">length</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s2">&quot;int&quot;</span><span class="p">),</span>
    <span class="p">)</span></div>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">doctest</span>

    <span class="n">doctest</span><span class="o">.</span><span class="n">testmod</span><span class="p">()</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<p class="logo">
  <a href="../../index.html">
    <img class="logo" src="../../_static/BloomLogo.jpg" alt="Logo"/>
    
    <h1 class="logo logo-name">alignparse</h1>
    
  </a>
</p>



<p class="blurb">Align sequences and then parse features.</p>




<p>
<iframe src="https://ghbtns.com/github-btn.html?user=jbloomlab&repo=alignparse&type=watch&count=true&size=large&v=2"
  allowtransparency="true" frameborder="0" scrolling="0" width="200px" height="35px"></iframe>
</p>





    

<p>
<a class="badge" href="https://travis-ci.org/jbloomlab/alignparse">
    <img
        alt="https://secure.travis-ci.org/jbloomlab/alignparse.svg?branch=master"
        src="https://secure.travis-ci.org/jbloomlab/alignparse.svg?branch=master"
    />
</a>
</p>


<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../index.html">alignparse documentation</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples.html">Examples</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../alignparse.html">alignparse package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../package_index.html">Package index</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../acknowledgements.html">Acknowledgements</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2019--2022.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.2.0</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    
    <a href="https://github.com/jbloomlab/alignparse" class="github">
        <img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_darkblue_121621.png" alt="Fork me on GitHub"  class="github"/>
    </a>
    

    
  </body>
</html>